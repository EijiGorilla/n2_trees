"use strict";(self.webpackChunkn2_trees=self.webpackChunkn2_trees||[]).push([[7764],{83544:(e,t,i)=>{i.d(t,{H:()=>pe,b:()=>he,c:()=>ue,s:()=>ce});var r,n,s,a,o,l,c,h,d,u,f,p,g,_,m,v,y,w,x,b,T,C,S,I,R,O,E,A,M,D,F,P,L=i(30168),B=i(13611),N=i(6644),U=i(86361),H=i(22186),z=i(37081),G=i(33280),V=i(14801),j=i(28156),Z=i(81879),Y=i(50913),q=i(25477),k=i(83744),W=i(10758),X=i(26461),J=i(116),Q=i(78980),K=i(62993),$=i(82552),ee=i(82999),te=i(20395),ie=i(95276),re=i(58406),ne=i(98634),se=i(64201),ae=i(19253),oe=i(14124),le=i(4760);const ce={occludedFadeFactor:.6};function he(e){const t=new se.kG,i=e.signedDistanceFieldEnabled;if(t.include(Z.R,e),t.include(G.f5,e),e.occlusionPass)return t.include(Y.R,e),t;const{vertex:N,fragment:he}=t;t.include(K.cK),t.include(W.k,e),t.include(V.R,e),t.include(q.P),he.include(Q.n),he.include(J.Y),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),t.varyings.add("voccluded","float"),N.uniforms.add(new ie.N("viewport",((e,t)=>t.camera.fullViewport)),new ee.A("screenOffset",((e,t)=>(0,B.t8)(fe,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new ee.A("anchorPosition",(e=>ue(e))),new ie.N("materialColor",(e=>e.color)),new re.p("materialRotation",(e=>e.rotation))),(0,$.ZI)(N),i&&(N.uniforms.add(new ie.N("outlineColor",(e=>e.outlineColor))),he.uniforms.add(new ie.N("outlineColor",(e=>de(e)?e.outlineColor:U.AG)),new re.p("outlineSize",(e=>de(e)?e.outlineSize:0)))),e.horizonCullingEnabled&&N.uniforms.add(new te.$("pointDistanceSphere",((e,t)=>{const i=t.camera.eye,r=e.origin;return(0,U.al)(r[0]-i[0],r[1]-i[1],r[2]-i[2],H.sv.radius)}))),e.pixelSnappingEnabled&&N.include(j.H),e.hasScreenSizePerspective&&((0,K.ww)(N),(0,K.m8)(N)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(le.T.UV0,"vec2"),t.attributes.add(le.T.COLOR,"vec4"),t.attributes.add(le.T.SIZE,"vec2"),t.attributes.add(le.T.ROTATION,"float"),t.attributes.add(le.T.FEATUREATTRIBUTE,"vec4"),N.code.add(e.horizonCullingEnabled?(0,ne.H)(r||(r=(0,L.Z)(["bool behindHorizon(vec3 posModel) {\nvec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;\nvec3 camToPos = pointDistanceSphere.xyz + posModel;\nfloat earthRadius = pointDistanceSphere.w;\nfloat a = dot(camToPos, camToPos);\nfloat b = dot(camToPos, camToEarthCenter);\nfloat c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;\nreturn  b > 0.0 && b < a && b * b  > a * c;\n}"]))):(0,ne.H)(n||(n=(0,L.Z)(["bool behindHorizon(vec3 posModel) { return false; }"])))),N.main.add((0,ne.H)(s||(s=(0,L.Z)(["\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      forwardObjectAndLayerIdColor();\n\n      if (rejectBySlice(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n\n      if (behindHorizon(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n\n      vec2 inputSize;\n      ","\n      ","\n\n      vec2 combinedSize = inputSize * pixelRatio;\n      vec4 quadOffset = vec4(0.0);\n      bool visible = testHUDVisibility(posProj);\n      voccluded = visible ? 0.0 : 1.0;\n    "])),(0,ne.If)(e.hasScreenSizePerspective,(0,ne.H)(a||(a=(0,L.Z)(["\n          inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);\n          vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);"]))),(0,ne.H)(o||(o=(0,L.Z)(["\n          inputSize = size;\n          vec2 screenOffsetScaled = screenOffset;"])))),(0,ne.If)(e.vvSize,(0,ne.H)(l||(l=(0,L.Z)(["inputSize *= vvScale(featureAttribute).xx;"]))))));const pe=(0,ne.H)(c||(c=(0,L.Z)(["\n      vec2 uv01 = floor(uv0);\n      vec2 uv = uv0 - uv01;\n      quadOffset.xy = (uv01 - anchorPosition) * 2.0 * combinedSize;\n\n      ","\n\n      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;\n  "])),(0,ne.If)(e.hasRotation,(0,ne.H)(h||(h=(0,L.Z)(["\n          float angle = radians(materialRotation + rotation);\n          float cosAngle = cos(angle);\n          float sinAngle = sin(angle);\n          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);\n\n          quadOffset.xy = rotate * quadOffset.xy;\n        "]))))),ge=e.pixelSnappingEnabled?i?(0,ne.H)(d||(d=(0,L.Z)(["posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;"]))):(0,ne.H)(u||(u=(0,L.Z)(["posProj += quadOffset;\nif (inputSize.x == size.x) {\nposProj = alignToPixelOrigin(posProj, viewport.zw);\n}"]))):(0,ne.H)(f||(f=(0,L.Z)(["posProj += quadOffset;"])));N.main.add((0,ne.H)(p||(p=(0,L.Z)(["\n    ","\n    ","\n    ","\n\n    ","\n\n    bool alphaDiscard = vcolor.a < ",";\n    ",'\n    if (alphaDiscard) {\n      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    } else {\n      ',"\n      gl_Position = posProj;\n    }\n\n    vtc = uv;\n\n    ","\n    vsize = inputSize;\n  "])),(0,ne.If)(e.occlusionTestEnabled,(0,ne.H)(g||(g=(0,L.Z)(["\n      if (!visible) {\n        vtc = vec2(0.0);\n        ","\n        return;\n      }"])),(0,ne.If)(e.debugDrawLabelBorder,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);"))),pe,e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;",(0,ne.If)(e.output===z.H_.ObjectAndLayerIdColor,(0,ne.H)(_||(_=(0,L.Z)(["vcolor.a = 1.0;"])))),ne.H.float(X.e),(0,ne.If)(i,"alphaDiscard = alphaDiscard && outlineColor.a < ".concat(ne.H.float(X.e),";")),ge,(0,ne.If)(e.debugDrawLabelBorder,(0,ne.H)(m||(m=(0,L.Z)(["debugBorderCoords = vec4(uv01, 1.5 / combinedSize);"])))))),he.uniforms.add(new ae.A("tex",(e=>e.texture))),e.occludedFragmentFade&&(he.uniforms.add(new ae.A("depthMap",((e,t)=>t.mainDepth))),he.uniforms.add(new re.p("fadeFactor",(()=>ce.occludedFadeFactor))));const _e=e.debugDrawLabelBorder?(0,ne.H)(v||(v=(0,L.Z)(["(isBorder > 0.0 ? 0.0 : ",")"])),ne.H.float(X.e)):ne.H.float(X.e),me=e.output===z.H_.Highlight,ve=(0,ne.H)(y||(y=(0,L.Z)(["\n    ","\n\n    ","\n\n    ","\n\n    ","\n\n    ","\n  "])),(0,ne.If)(e.debugDrawLabelBorder,(0,ne.H)(w||(w=(0,L.Z)(["float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));"])))),(0,ne.If)(e.sampleSignedDistanceFieldTexelCenter,(0,ne.H)(x||(x=(0,L.Z)(["\n      float txSize = float(textureSize(tex, 0).x);\n      float texelSize = 1.0 / txSize;\n\n      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel\n      vec2 scaleFactor = (vsize - txSize) * texelSize;\n      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;"]))),(0,ne.H)(b||(b=(0,L.Z)(["vec2 samplePos = vtc;"])))),i?(0,ne.H)(T||(T=(0,L.Z)(["\n      vec4 fillPixelColor = vcolor;\n\n      // Get distance and map it into [-0.5, 0.5]\n      float d = rgba2float(texture(tex, samplePos)) - 0.5;\n\n      // Distance in output units (i.e. pixels)\n      float dist = d * vsize.x;\n\n      // Create smooth transition from the icon into its outline\n      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);\n      fillPixelColor.a *= fillAlphaFactor;\n\n      if (outlineSize > 0.25) {\n        vec4 outlinePixelColor = outlineColor;\n        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);\n\n        // Create smooth transition around outline\n        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);\n        outlinePixelColor.a *= outlineAlphaFactor;\n\n        if (\n          outlineAlphaFactor + fillAlphaFactor < "," ||\n          fillPixelColor.a + outlinePixelColor.a < ","\n        ) {\n          discard;\n        }\n\n        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)\n        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);\n        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +\n          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);\n\n        ","\n      } else {\n        if (fillAlphaFactor < ",") {\n          discard;\n        }\n\n        ","\n      }\n\n      // visualize SDF:\n      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);\n      "])),_e,ne.H.float(X.e),(0,ne.If)(!me,(0,ne.H)(C||(C=(0,L.Z)(["fragColor = vec4(compositeColor, compositeAlpha);"])))),_e,(0,ne.If)(!me,(0,ne.H)(S||(S=(0,L.Z)(["fragColor = premultiplyAlpha(fillPixelColor);"]))))):(0,ne.H)(I||(I=(0,L.Z)(["\n          vec4 texColor = texture(tex, vtc, -0.5);\n          if (texColor.a < ",") {\n            discard;\n          }\n          ","\n          "])),_e,(0,ne.If)(!me,(0,ne.H)(R||(R=(0,L.Z)(["fragColor = texColor * premultiplyAlpha(vcolor);"]))))),(0,ne.If)(e.occludedFragmentFade&&!me,(0,ne.H)(O||(O=(0,L.Z)(["\n        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;\n        if (zSample < gl_FragCoord.z) {\n          fragColor *= fadeFactor;\n        }\n        "])))),(0,ne.If)(!me&&e.debugDrawLabelBorder,(0,ne.H)(E||(E=(0,L.Z)(["fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);"])))));switch(e.output){case z.H_.Color:e.oitPass===oe.M.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),he.main.add((0,ne.H)(A||(A=(0,L.Z)(["\n        ","\n        ","\n        ",""])),ve,(0,ne.If)(e.oitPass===oe.M.FrontFace,(0,ne.H)(M||(M=(0,L.Z)(["fragColor.rgb /= fragColor.a;"])))),(0,ne.If)(e.oitPass===oe.M.ColorAlpha,(0,ne.H)(D||(D=(0,L.Z)(["fragAlpha = fragColor.a;"]))))));break;case z.H_.ObjectAndLayerIdColor:he.main.add((0,ne.H)(F||(F=(0,L.Z)(["\n        ","\n        outputObjectAndLayerIdColor();"])),ve));break;case z.H_.Highlight:t.include(k.b,e),he.main.add((0,ne.H)(P||(P=(0,L.Z)(["\n        ","\n        outputHighlight(voccluded == 1.0);"])),ve))}return t}function de(e){return e.outlineColor[3]>0&&e.outlineSize>0}function ue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fe;return e.textureIsSignedDistanceField?function(e,t,i){null!=t?(0,B.t8)(i,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,B.t8)(i,0,0)}(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,B.JG)(t,e.anchorPosition),t}const fe=(0,N.Ue)(),pe=Object.freeze(Object.defineProperty({__proto__:null,build:he,calculateAnchorPosForRendering:ue,shaderSettings:ce},Symbol.toStringTag,{value:"Module"}))},46228:(e,t,i)=>{i.d(t,{I:()=>n,v:()=>s});var r=i(16889);function n(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=(0,r.uZ)(e,0,l);for(let r=0;r<4;r++)t[i+r]=Math.floor(256*c(n*a[r]))}function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;for(let r=0;r<4;r++)i+=e[t+r]*o[r];return i}const a=[1,256,65536,16777216],o=[1/256,1/65536,1/16777216,1/4294967296],l=s(new Uint8ClampedArray([255,255,255,255]));function c(e){return e-Math.floor(e)}},93311:(e,t,i)=>{function r(){return new Float32Array(3)}function n(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function s(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function a(){return r()}function o(){return s(1,1,1)}function l(){return s(1,0,0)}function c(){return s(0,1,0)}function h(){return s(0,0,1)}i.d(t,{Ue:()=>r,al:()=>s,d9:()=>n});const d=a(),u=o(),f=l(),p=c(),g=h();Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:f,UNIT_Y:p,UNIT_Z:g,ZEROS:d,clone:n,create:r,createView:function(e,t){return new Float32Array(e,t,3)},fromValues:s,ones:o,unitX:l,unitY:c,unitZ:h,zeros:a},Symbol.toStringTag,{value:"Module"}))},13491:(e,t,i)=>{i.d(t,{Q:()=>a,b:()=>C});var r=i(63780),n=(i(93169),i(27546)),s=i(36231);class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t=arguments.length>1?arguments[1]:void 0;this._compareMinX=d,this._compareMinY=u,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),w.prune(),x.prune(),b.prune(),T.prune()}all(e){o(this._data,e)}search(e,t){let i=this._data;const r=this._toBBox;if(v(e,i))for(w.clear();i;){for(let n=0,s=i.children.length;n<s;n++){const s=i.children[n],a=i.leaf?r(s):s;v(e,a)&&(i.leaf?t(s):m(e,a)?o(s,t):w.push(s))}i=w.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!v(e,t))return!1;for(w.clear();t;){for(let r=0,n=t.children.length;r<n;r++){const n=t.children[r],s=t.leaf?i(n):n;if(v(e,s)){if(t.leaf||m(e,s))return!0;w.push(n)}}t=w.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new I([]),this}remove(e){if(!e)return this;let t,i=this._data,n=null,s=0,a=!1;const o=this._toBBox(e);for(b.clear(),T.clear();i||b.length>0;){var l;if(i||(i=b.pop(),n=b.data[b.length-1],s=null!==(l=T.pop())&&void 0!==l?l:0,a=!0),i.leaf&&(t=(0,r.cq)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),b.push(i),this._condense(b),this;a||i.leaf||!m(i,o)?n?(s++,i=n.children[s],a=!1):i=null:(b.push(i),T.push(s),s=0,n=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,i,r){const n=i-t+1;let s=this._maxEntries;if(n<=s){const r=new I(e.slice(t,i+1));return l(r,this._toBBox),r}r||(r=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/s**(r-1)));const a=new R([]);a.height=r;const o=Math.ceil(n/s),c=o*Math.ceil(Math.sqrt(s));y(e,t,i,c,this._compareMinX);for(let l=t;l<=i;l+=c){const t=Math.min(l+c-1,i);y(e,l,t,o,this._compareMinY);for(let i=l;i<=t;i+=o){const n=Math.min(i+o-1,t);a.children.push(this._build(e,i,n,r-1))}}return l(a,this._toBBox),a}_insert(e,t,i){const r=this._toBBox,n=i?e:r(e);b.clear();const s=function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,n=1/0;for(let s=0,a=t.children.length;s<a;s++){const a=t.children[s],o=f(a),l=g(e,a)-o;l<n?(n=l,r=o<r?o:r,i=a):l===n&&o<r&&(r=o,i=a)}t=i||t.children[0]}return t}(n,this._data,t,b);for(s.children.push(e),h(s,n);t>=0&&b.data[t].children.length>this._maxEntries;)this._split(b,t),t--;!function(e,t,i){for(let r=i;r>=0;r--)h(t.data[r],e)}(n,b,t)}_split(e,t){const i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);const s=this._chooseSplitIndex(i,n,r);if(!s)return;const a=i.children.splice(s,i.children.length-s),o=i.leaf?new I(a):new R(a);o.height=i.height,l(i,this._toBBox),l(o,this._toBBox),t?e.data[t-1].children.push(o):this._splitRoot(i,o)}_splitRoot(e,t){this._data=new R([e,t]),this._data.height=e.height+1,l(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let r,n,s;r=n=1/0;for(let a=t;a<=i-t;a++){const t=c(e,0,a,this._toBBox),o=c(e,a,i,this._toBBox),l=_(t,o),h=f(t)+f(o);l<r?(r=l,s=a,n=h<n?h:n):l===r&&h<n&&(n=h,s=a)}return s}_chooseSplitAxis(e,t,i){const r=e.leaf?this._compareMinX:d,n=e.leaf?this._compareMinY:u;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const n=this._toBBox,s=c(e,0,t,n),a=c(e,i-t,i,n);let o=p(s)+p(a);for(let l=t;l<i-t;l++){const t=e.children[l];h(s,e.leaf?n(t):t),o+=p(s)}for(let l=i-t-1;l>=t;l--){const t=e.children[l];h(a,e.leaf?n(t):t),o+=p(a)}return o}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const n=e.data[t-1],s=n.children;s.splice((0,r.cq)(s,i,s.length,n.indexHint),1)}else this.clear();else l(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function o(e,t){let i=e;for(x.clear();i;){var r;if(!0===i.leaf)for(const e of i.children)t(e);else x.pushArray(i.children);i=null!==(r=x.pop())&&void 0!==r?r:null}}function l(e,t){c(e,0,e.children.length,t,e)}function c(e,t,i,r,n){n||(n=new I([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let s,a=t;a<i;a++)s=e.children[a],h(n,e.leaf?r(s):s);return n}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function d(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function f(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function p(e){return e.maxX-e.minX+(e.maxY-e.minY)}function g(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function _(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,s-r)}function m(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function v(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function y(e,t,i,r,n){const a=[t,i];for(;a.length;){const t=a.pop(),i=a.pop();if(t-i<=r)continue;const o=i+Math.ceil((t-i)/r/2)*r;(0,s.q)(e,o,i,t,n),a.push(i,o,o,t)}}const w=new n.Z,x=new n.Z,b=new n.Z,T=new n.Z({deallocator:void 0});class C{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class S extends C{constructor(){super(...arguments),this.height=1,this.indexHint=new r.SO}}class I extends S{constructor(e){super(),this.children=e,this.leaf=!0}}class R extends S{constructor(e){super(),this.children=e,this.leaf=!1}}},68859:(e,t,i)=>{i.d(t,{K:()=>a});var r=i(12400),n=i(45925),s=i(50628);function a(e,t,i,r){var a,l;if((0,n.canProjectWithoutEngine)(e.spatialReference,i)){var c;o[0]=e.x,o[1]=e.y;const n=e.z;return o[2]=null!==(c=null!==n&&void 0!==n?n:r)&&void 0!==c?c:0,(0,s.projectBuffer)(o,e.spatialReference,0,t,i,0)}const h=(0,n.tryProjectWithZConversion)(e,i);return!!h&&(t[0]=null===h||void 0===h?void 0:h.x,t[1]=null===h||void 0===h?void 0:h.y,t[2]=null!==(a=null!==(l=null===h||void 0===h?void 0:h.z)&&void 0!==l?l:r)&&void 0!==a?a:0,!0)}const o=(0,r.Ue)()},5986:(e,t,i)=>{i.d(t,{S:()=>s});i(45925);var r=i(78952),n=i(68859);function s(e,t,i,r,s){return!(null==t||null==r||e.length<2)&&(a.x=e[0],a.y=e[1],a.z=e[2],a.spatialReference=t,(0,n.K)(a,i,r,s))}const a=(0,i(55946).T)(0,0,0,r.Z.WGS84)},8623:(e,t,i)=>{i.d(t,{Z:()=>d});var r,n=i(27366),s=i(11582),a=i(46784),o=i(49861),l=(i(93169),i(32718),i(84936),i(27135)),c=i(69912);let h=r=class extends((0,s.J)(a.wq)){constructor(e){super(e),this.type="georeferenced",this.origin=null}};h.absolute=new r,(0,n._)([(0,l.J)({georeferenced:"georeferenced"},{readOnly:!0})],h.prototype,"type",void 0),(0,n._)([(0,o.Cb)({type:[Number],nonNullable:!1,json:{write:!0}})],h.prototype,"origin",void 0),h=r=(0,n._)([(0,c.j)("esri.geometry.support.MeshGeoreferencedVertexSpace")],h);const d=h},50250:(e,t,i)=>{i.d(t,{Z:()=>d});var r=i(27366),n=i(11582),s=i(46784),a=i(49861),o=(i(93169),i(32718),i(84936),i(27135)),l=i(69912),c=i(12400);let h=class extends((0,n.J)(s.wq)){constructor(e){super(e),this.type="local",this.origin=(0,c.Ue)()}};(0,r._)([(0,o.J)({local:"local"},{readOnly:!0})],h.prototype,"type",void 0),(0,r._)([(0,a.Cb)({type:[Number],nonNullable:!0,json:{write:!0}})],h.prototype,"origin",void 0),h=(0,r._)([(0,l.j)("esri.geometry.support.MeshLocalVertexSpace")],h);const d=h},69048:(e,t,i)=>{i.d(t,{G7:()=>f,QK:()=>d,rU:()=>u,vI:()=>p,zZ:()=>h});var r=i(44927),n=i(32718),s=i(32035),a=i(848),o=i(8623),l=i(50250);function c(){return n.Z.getLogger("esri.geometry.Mesh")}function h(e){return null!=e.origin}function d(e){return h(e.vertexSpace)}function u(e,t){if(!h(e))return null;const[i,r,n]=e.origin;return new a.Z({x:i,y:r,z:n,spatialReference:t})}function f(e,t){var i,n;const{x:s,y:a,z:h,spatialReference:d}=e,u=[s,a,null!==h&&void 0!==h?h:0];return void 0!==(null===t||void 0===t?void 0:t.geographic)&&((0,r.x9)(c(),"option: geographic",{replacement:"Use the `vertexSpace` option instead.",version:"4.29",warnOnce:!0}),t.vertexSpace&&c().warn("Deprecated geographic flag ignored since vertexSpace option is provided.")),"local"===(null!==(i=null!==(n=null===t||void 0===t?void 0:t.vertexSpace)&&void 0!==n?n:function(e){return null==e?void 0:e?"local":"georeferenced"}(null===t||void 0===t?void 0:t.geographic))&&void 0!==i?i:function(e){return e.isGeographic||e.isWebMercator?"local":"georeferenced"}(d))?new l.Z({origin:u}):new o.Z({origin:u})}function p(e,t){return e.type===t.type&&(e.origin===t.origin||null!=e.origin&&null!=t.origin&&(0,s.p)(e.origin,t.origin))}},55946:(e,t,i)=>{function r(e,t,i,r){return{x:e,y:t,z:i,hasZ:null!=i,hasM:!1,spatialReference:r,type:"point"}}function n(e,t,i,r,n){e.x=t,e.y=i,e.z=r,e.hasZ=null!=r,e.spatialReference=n}i.d(t,{T:()=>r,y:()=>n})},37818:(e,t,i)=>{i.d(t,{WG:()=>s});i(59486),i(52639),i(93169),i(84652),i(18722),i(77981);var r=i(55946);i(78952);function n(e){return"declaredClass"in e}function s(e,t){if(!e)return null;let i;if(n(e)){if(null==t)return e.clone();if(n(t))return t.copy(e)}return null!=t?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=void 0,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=void 0,i.hasM=!1)):(i=(0,r.T)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}},22585:(e,t,i)=>{function r(e){const t={};for(const i in e){if("declaredClass"===i)continue;const n=e[i];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){t[i]=[];for(let e=0;e<n.length;e++)t[i][e]=r(n[e])}else"object"==typeof n?n.toJSON&&(t[i]=JSON.stringify(n)):t[i]=n}return t}i.d(t,{A:()=>r})},5192:(e,t,i)=>{i.d(t,{Ev:()=>m,JT:()=>p,Vr:()=>y,hH:()=>v,n7:()=>_,qp:()=>g});var r=i(1413),n=i(76200),s=i(35995),a=i(77981),o=i(91340),l=i(92975),c=i(22585),h=i(27607),d=i(68620);const u="Layer does not support extent calculation.";function f(e,t){var i;const r=e.geometry,n=e.toJSON();delete n.compactGeometryEnabled,delete n.defaultSpatialReferenceEnabled;const s=n;let o,c,h;if(null!=r&&(c=r.spatialReference,h=(0,l.B9)(c),s.geometryType=(0,a.Ji)(r),s.geometry=function(e,t){if(t&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(t&&"point"===e.type)return"".concat(e.x,",").concat(e.y);const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}(r,e.compactGeometryEnabled),s.inSR=h),n.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(s.objectIds=n.objectIds.join(",")),n.orderByFields&&(s.orderByFields=n.orderByFields.join(",")),!n.outFields||!n.returnDistinctValues&&(null!==t&&void 0!==t&&t.returnCountOnly||null!==t&&void 0!==t&&t.returnExtentOnly||null!==t&&void 0!==t&&t.returnIdsOnly)?delete s.outFields:n.outFields.includes("*")?s.outFields="*":s.outFields=n.outFields.join(","),n.outSR?(s.outSR=(0,l.B9)(n.outSR),o=e.outSpatialReference):r&&(n.returnGeometry||n.returnCentroid)&&(s.outSR=s.inSR,o=c),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(s.outStatistics=JSON.stringify(n.outStatistics)),n.fullText&&(s.fullText=JSON.stringify(n.fullText)),n.pixelSize&&(s.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=c&&null!=(null===(i=e.quantizationParameters)||void 0===i?void 0:i.extent)&&c.equals(e.quantizationParameters.extent.spatialReference)&&delete n.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.parameterValues&&(s.parameterValues=JSON.stringify(n.parameterValues)),n.rangeValues&&(s.rangeValues=JSON.stringify(n.rangeValues)),n.dynamicDataSource&&(s.layer=JSON.stringify({source:n.dynamicDataSource}),delete n.dynamicDataSource),n.timeExtent){const e=n.timeExtent,{start:t,end:i}=e;null==t&&null==i||(s.time=t===i?t:"".concat(null!==t&&void 0!==t?t:"null",",").concat(null!==i&&void 0!==i?i:"null")),delete n.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=c&&null!=o&&c.equals(o)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function p(e,t,i,r){const n=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await w(e,t,"json",r);return(0,d.p)(t,i,n.data),n}async function g(e,t,i,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const n=await _(e,t,r),s=n;return s.data=(0,h.C)(n.data,i),s}function _(e,t,i){return w(e,t,"pbf",i)}function m(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):w(e,t,"json",i,{returnIdsOnly:!0})}function v(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):w(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}async function y(e,t,i){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await w(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),n=r.data;if(n.hasOwnProperty("extent"))return r;if(n.features)throw new Error(u);if(n.hasOwnProperty("count"))throw new Error(u);return r}async function w(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const h="string"==typeof e?(0,s.mN)(e):e,d=t.geometry?[t.geometry]:[],u=await(0,o.aX)(d,null,{signal:a.signal}),p=null===u||void 0===u?void 0:u[0];null!=p&&((t=t.clone()).geometry=p);const g=(0,c.A)((0,r.Z)((0,r.Z)((0,r.Z)({},h.query),{},{f:i},l),f(t,l)));return(0,n.Z)((0,s.v_)(h.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(t,l)?"query3d":"query"),(0,r.Z)((0,r.Z)({},a),{},{responseType:"pbf"===i?"array-buffer":"json",query:(0,r.Z)((0,r.Z)({},g),a.query)}))}},7764:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Mn});var r=i(27366),n=i(91505),s=i(66978),a=i(94172),o=i(49861),l=i(93169),c=i(32718),h=(i(84936),i(69912)),d=i(78952),u=i(81655),f=i(21149),p=i(7138),g=i(14921),_=i(18442);let m=class extends p.Z{constructor(e){super(e),this._removing=0,this._tiles=new _.Z}destroy(){for(const e of this._tiles.values())e.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(const e of this._tiles.values())if(!e.finished)return!0;return!1}async onTileTreeChange(e){const{added:t,removed:i}=e,r=this._tiles,n=[];for(const s of i){const e=r.get(s);null!=e&&(e.abort(),r.delete(s),n.push({tileId:s}))}for(const s of t)r.has(s.id)||r.set(s.id,(0,g.vr)((e=>this._addTile(s,e))));await this._removeTiles(n)}async _addTile(e,t){const i=await this.addTile(e,t);return(0,s.k_)(t),i}async _removeTiles(e){this._removing++,await this.removeTiles(e),this._removing--}};(0,r._)([(0,o.Cb)()],m.prototype,"updating",null),(0,r._)([(0,o.Cb)({constructOnly:!0})],m.prototype,"addTile",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],m.prototype,"removeTiles",void 0),(0,r._)([(0,o.Cb)()],m.prototype,"_removing",void 0),m=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],m);var v=i(13491),y=i(85403),w=i(80457);class x{constructor(e,t){this._index=e,this._view=t}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new b(this._index,this._view,e)}}class b extends x{constructor(e,t,i){super(e,t),this._geometryOverride=i}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return(0,y.Y)(new w.Z,this._geometryOverride,e.hasZ,e.hasM)}}class T{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new n.Z,this.featureAdapter=C.shared}addTile(e){this._storedTiles.set(e.descriptor.id,e);for(const t of e.pages)this._addPage(t)}removeTile(e){const t=this._storedTiles,i=t.get(e);if(null!=i){t.delete(e);for(const e of i.pages)this._removePage(e)}}_addPage(e){const{featureCount:t}=e;if(0===t)return;const i=new v.Q(9,(t=>e.getBounds(t))),r=new Array;for(let n=0;n<t;++n)r[n]=n;i.load(r),this._pageBounds.set(e,i),this.events.emit("changed")}_removePage(e){this._pageBounds.delete(e),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,i]of this._pageBounds)i.all((i=>e(new x(i,t))))}forEachInBounds(e,t){S.minX=e[0],S.minY=e[1],S.maxX=e[2],S.maxY=e[3];for(const[i,r]of this._pageBounds)r.search(S,(e=>t(new x(e,i))))}forEachBounds(e,t){for(const i of e)t(i.getBoundingBox())}getFullExtent(e){let t=1/0,i=1/0,r=-1/0,n=-1/0;for(const s of this._pageBounds.values()){const{minX:e,minY:a,maxX:o,maxY:l}=s.toJSON();t=Math.min(t,e),i=Math.min(i,a),r=Math.min(r,o),n=Math.min(n,l)}return{xmin:t,ymin:i,xmax:r,ymax:n,spatialReference:e}}}class C{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}}C.shared=new C;const S=new v.b;var I=i(65156),R=i(5192);class O{constructor(e,t){this.descriptor=e,this.pages=t}}var E=i(10064),A=i(78084),M=i(12400),D=i(41414),F=i(58971),P=i(52410),L=i(91347);class B{constructor(e){const t=new A.Z(new Uint8Array(e),new DataView(e));this._reader=t,this._index=function(e){const t=2;for(;e.next();){if(e.tag()===t)return N(e.getMessage());e.skip()}H()}(t)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){var i;const{_index:{fieldsIndex:r,attributeIndices:n}}=this,s=null===(i=r.get(t))||void 0===i?void 0:i.index;if(null==s)return;const a=n[e*r.fields.length+s],o=this._reader;return o.move(a),z(o)}getAttributeAsTimestamp(e,t){const i=this.getAttribute(e,t);return"string"==typeof i?new Date(i).getTime():"number"==typeof i||null==i?i:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:i}}=this,r=e*t.fields.length,n=this._reader,s={};for(const a of t.fields){const e=i[r+a.index];n.move(e),s[a.name]=z(n)}return s}getCoordinates(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const r=this._reader,{transform:n,featureIndices:s}=this._index,{scale:a,translate:o}=n;r.move(s[e]),this._readCoordinates(a,o,t,i)}getOptimizedGeometry(e){const t=(0,M.Ue)();return this.getCoordinates(e,t),new w.Z([],t)}getCentroid(e,t){let{hasZ:i,hasM:r}=t;this.getCoordinates(e,G);const[n,s,a]=G,o=[n,s];return i&&(o[3]=a),r&&(o[i?4:3]=0),new w.Z([],o)}getBounds(e){this.getCoordinates(e,G);const[t,i]=G,r=new v.b;return r.minX=t,r.minY=i,r.maxX=t,r.maxY=i,r}getBoundingBox(e){this.getCoordinates(e,G);const[t,i,r]=G;return(0,D.al)(t,i,r,t,i,r)}readAllObjectIds(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=this._reader,{_index:r,featureCount:n}=this,{objectIdFieldName:s,attributeIndices:a,fieldsIndex:o}=r,l=o.get(s).index,c=o.fields.length;for(let h=0;h<n;++h){const r=a[h*c+l];i.move(r),e[t++]=z(i)}return t}readAllCoordinates(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=this._reader,{transform:r,featureIndices:n}=this._index,{scale:s,translate:a}=r;for(const o of n)i.move(o),t=this._readCoordinates(s,a,e,t);return t}_readCoordinates(e,t,i,r){let[n,s,a]=e,[o,l,c]=t;const h=this._reader,d=h.getLength(),u=h.pos()+d;for(;h.pos()<u&&h.next();)switch(h.tag()){case 2:{const e=h.getLength(),t=h.pos()+e;for(;h.pos()<t&&h.next();)3===h.tag()?(h.getUInt32(),i[r++]=o+n*h.getSInt64(),i[r++]=l+s*h.getSInt64(),i[r++]=c+a*h.getSInt64()):h.skip();break}default:h.skip()}return r}}function N(e){for(;e.next();){if(1===e.tag())return U(e.getMessage());e.skip()}H()}function U(e){var t,i;let r,n,s=!1,a=!1,o=0;const l=new Array,c=new Array,h=new Array;for(;e.next();)switch(e.tag()){case 1:n=e.getString();break;case 7:0!==e.getEnum()&&H();break;case 9:s=null!==(t=e.getBool())&&void 0!==t&&t;break;case 12:r=(0,F.oh)(e.processMessage(L.G$));break;case 13:{const t=e.processMessage(L.wn);t.index=o++,l.push(t);break}case 15:{c.push(e.pos());const t=e.getUInt32(),i=e.pos()+t;for(;e.pos()<i&&e.next();)1===e.tag()?(h.push(e.pos()),e.skip()):e.skip();break}case 10:a=null!==(i=e.getBool())&&void 0!==i&&i;break;default:e.skip()}const d=new P.Z(l);return null!=r&&a&&null!=n&&d.has(n)||H(),{transform:r,exceededTransferLimit:s,fieldsIndex:d,objectIdFieldName:n,featureIndices:c,attributeIndices:h}}function H(){const e=new E.Z("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function z(e){const t=e.getLength(),i=e.pos()+t;for(;e.pos()<i&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const G=(0,M.Ue)();class V{constructor(e,t,i,r,n){this.spatialReference=e,this.url=i,this.objectIdField=r,this.capabilities=n;const{supportsMaxRecordCountFactor:s,maxRecordCount:a}=this.capabilities.query,o=s?4:1,l=(null!==a&&void 0!==a?a:8e3)*o;this._pageSize=Math.min(8e3,l);const c=t.clone();c.cacheHint=!0,c.resultType="tile",c.outSpatialReference=e,c.returnGeometry=!0,c.returnZ=!0,c.maxRecordCountFactor=o,c.num=this._pageSize,c.outFields=[r],this._baseQuery=c}async fetch(e,t){const{spatialReference:i}=this,r=(0,I.HH)(e.extent,i),n=this._baseQuery.clone();n.geometry=r;const a=new Array;let o=0,l=!1,c=1;for(;!l;){const e=[];for(let r=0;r<c;++r)e.push(this._fetchPage(n,o++,t));const i=await Promise.all(e);(0,s.k_)(t);for(const t of i){const e=0!==t.featureCount;l||(l=!t.exceededTransferLimit||!e),e&&a.push(t)}c=Math.min(c+1,4)}return new O(e,a)}async _fetchPage(e,t,i){const r=e.clone();r.start=t*this._pageSize;const n=(await(0,R.n7)(this.url,r,{signal:i})).data;return(0,s.k_)(i),new B(n)}}var j=i(50951),Z=i(39406),Y=i(42537),q=i(92026),k=i(86361),W=i(13611),X=i(6644),J=i(16889),Q=i(94463);new Map;(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t)})();const K=[];{const e=16;for(let t=0;t<360;t+=360/e)K.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var $;!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}($||($={}));Object.freeze({left:0,center:.5,right:1});const ee=Object.freeze({"bottom-left":(0,X.al)(0,0),bottom:(0,X.al)(.5,0),"bottom-right":(0,X.al)(1,0),left:(0,X.al)(0,.5),center:(0,X.al)(.5,.5),right:(0,X.al)(1,.5),"top-left":(0,X.al)(0,1),top:(0,X.al)(.5,1),"top-right":(0,X.al)(1,1)});var te=i(50256),ie=i(37081);const re={required:[]};ie.H_.Depth;class ne extends p.Z{precompile(e){const t=this.acquireTechniques(e);return function(e){Array.isArray(e)?e.forEach((e=>null===e||void 0===e?void 0:e.release())):null===e||void 0===e||e.release()}(t),null!=t}consumes(){return re}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}}class se extends ne{}class ae extends ne{}var oe=i(68401);class le{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,i){const r=this._material.produces.get(t);if(null===r||void 0===r||!r(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const n=this._map.get(i);if(null!=n){if(n.ensureResources(e)===oe.Rw.LOADED)return n;this._repository.requestRender()}return null}}var ce=i(93822),he=i(85380);class de extends he.Pf{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,M.Ue)();super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}var ue,fe,pe=i(63780),ge=i(59447),_e=i(27546),me=i(92377),ve=i(29134),ye=i(7025);!function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(ue||(ue={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(fe||(fe={}));var we=i(97731);class xe{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=e,this.to=t}get numElements(){return this.to-this.from}}function be(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const n=e.data[r],s=t.get(n.to);if(!s)return;n.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0}}}class Te extends xe{constructor(e,t,i){super(t,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(e){this.isVisible&&this.geometry.foreachHighlightGroup(e)}get hasOccludees(){return null!=this.geometry.occludees}}class Ce{constructor(){this.first=0,this.count=0}}class Se{constructor(){this._numElements=0,this._instances=new Map,this.holes=new _e.Z({allocator:e=>e||new xe,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=Ie(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=Ie(),this.drawCommandsShadowHighlightRest=Ie()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.foreachHighlightGroup((e=>this.highlightGroups.add(e))),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),i=this.holes.front();return null!=this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=i.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)),{drawCommandsHighlights:i}=this;for(const r of t)r.isVisible&&(Re(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r),r.hasHighlights?r.foreachHighlightGroup((e=>{let t=i.get(e);t||(t=Ie(),i.set(e,t)),Re(t,r)})):Re(this.drawCommandsShadowHighlightRest,r))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function Ie(){return new _e.Z({allocator:e=>e||new Ce,deallocator:e=>e})}function Re(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class Oe{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}let Ee=class extends se{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new de,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=(0,q.M2)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==ie.H_.Highlight&&t!==ie.H_.ShadowHighlight||this._hasAnyHighlight))&&e(t)))}))}initializeRenderContext(e,t){this._glMaterials=new le(this.material,null!==t&&void 0!==t?t:e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,te.K)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>{let{geometry:i}=t;return e(i)}))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null==t)return;const i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,n=this._dataByOrigin.get(e.localOrigin.id),s=null===n||void 0===n?void 0:n.findBuffer(e.id);if(null==s)return;const a=s.instances.get(e.id);if(r.updateType&(fe.GEOMETRY|fe.TRANSFORMATION)){const r=Ge(t.elementCount(a.geometry.geometry.attributes)*i),n=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,n,0),s.vao.vertexBuffers.get("geometry").setSubData(r,a.from*i,0,a.numElements*i)}r.updateType&(fe.HIGHLIGHT|fe.OCCLUDEE|fe.VISIBILITY)&&(s.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new ge.r;for(const r of e){const e=r.localOrigin;if(null==e)continue;let t=i.get(e.id,null);null==t&&(t=new Ae(e.vec3),i.set(e.id,null,t)),t.changes.push(r)}for(const r of t){const e=r.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),n=null===t||void 0===t?void 0:t.findBuffer(r.id);if(null==n)continue;let s=i.get(e.id,n);null==s&&(s=new Ae(e.vec3),i.set(e.id,n,s)),s.changes.push(r)}return i}_addAndRemoveGeometries(e,t){if(null==this._bufferWriter||null==this._vaoCache)return;const{_bufferWriter:i,_dataByOrigin:r}=this,n=i.vertexBufferLayout.stride/4,s=this._computeDeltas(e,t);s.forEach(((e,t)=>{var a;const o=e.get(null),l=null!==(a=null===o||void 0===o?void 0:o.changes)&&void 0!==a?a:[];s.delete(t,null);let c=r.get(t);if(e.forEach(((e,a)=>{if(s.delete(t,a),null==a)return void(0,we.hu)(!1,"No VAO for removed geometries");if(a.instances.size===e.changes.length)return this._vaoCache.deleteVao(a.vao),(0,pe.e$)(c.buffers,a),void(0===c.buffers.length&&0===l.length&&r.delete(t));const o=a.numElements,h=a.vao.byteSize/4,d=l.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),u=e.changes.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),f=Math.min((o+d-u)*n,He),p=f>h;f>Le&&f<h/2?(e.changes.forEach((e=>{let{id:t}=e;return a.deleteInstance(t)})),a.instances.forEach((e=>{let{geometry:t}=e;return l.push(t)})),this._vaoCache.deleteVao(a.vao),(0,pe.e$)(c.buffers,a)):p?this._applyAndRebuild(a,l,e):this._applyRemoves(a,e)})),l.length>0)for(null==c&&(c=new Oe(o.origin),r.set(t,c)),c.buffers.forEach((e=>this._applyAdds(e,l)));l.length>0;)c.buffers.push(this._applyAndRebuild(new Se,l,null))}))}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&(0,me.w6)(this._highlightGroups,e.highlightGroups),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(i)for(const f of i.changes)e.deleteInstance(f.id);const r=this._bufferWriter,n=r.vertexBufferLayout.stride,s=n/4,a=Math.floor(He/s);let o=e.numElements;for(;t.length>0;){const i=t.pop(),n=r.elementCount(i.geometry.attributes);if(o+n>a&&o>0){t.push(i);break}o+=n;const s=new Te(i,0,0);(0,we.hu)(null==e.instances.get(i.id)),e.addInstance(i.id,s)}const l=o*s,c=Ge(l),h=r.vertexBufferLayout.createView(c.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,h,d);const n=d;d+=r.elementCount(t.geometry.geometry.attributes),e.updateInstance(i,n,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Ve(l)),e.vao.vertexBuffers.get("geometry").setSubData(c,0,0,d*s),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.byteSize/n),e.updateDrawCommands(n),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;for(const a of t.changes){const t=a.id,i=e.instances.get(t);if(!i)continue;e.deleteInstance(t);const r=Pe.back();if(r){if(r.to===i.from){r.to=i.to;continue}if(r.from===i.to){r.from=i.from;continue}}const n=Pe.pushNew();n.from=i.from,n.to=i.to}be(Pe);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=Pe.reduce(((e,t)=>Math.max(e,t.numElements)),0)*i,n=Ge(r);n.fill(0,0,r);const s=e.vao.vertexBuffers.get("geometry");Pe.forAll((e=>s.setSubData(n,e.from*i,0,e.numElements*i))),e.holes.pushArray(Pe.data,Pe.length),Pe.forAll(((e,t)=>Pe.data[t]=null)),Pe.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=e.numElements,s=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),a=Math.min((n+s)*r,He),o=4*a;if(e.vao.byteSize<Ve(He-Le)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);be(e.holes);const l=new Array;for(const _ of t){const t=i.elementCount(_.geometry.attributes),r=Me(e.holes,t);l.push(r)}const c=e.vao.vertexBuffers.get("geometry");let h=0,d=0,u=0;const f=Ge(a),p=i.vertexBufferLayout.createView(f.buffer);t.forEach(((t,n)=>{const s=l[n];if(null==s)return;if(u!==s){const e=u-d;e>0&&c.setSubData(f,d*r,0,e*r),d=s,h=0}const a=i.elementCount(t.geometry.attributes);this._writeGeometry(t,p,h),h+=a,u=s+a;const o=new Te(t,s,s+a);(0,we.hu)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=u-d;g>0&&c.setSubData(f,d*r,0,g*r),(0,pe.hv)(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,i){null!=this._bufferWriter&&((0,ve.JG)(De,e.transformation),De[12]-=e.localOrigin.vec3[0],De[13]-=e.localOrigin.vec3[1],De[14]-=e.localOrigin.vec3[2],(0,ve.U_)(Fe,De),(0,ve.p4)(Fe,Fe),this._bufferWriter.write(De,Fe,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,i))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e,r=this.material.produces.get(i.slot);if(null===r||void 0===r||!r(t))return null;const{highlightGroupName:n,slot:s}=i,a=t===ie.H_.ShadowHighlight,o=t===ie.H_.Highlight,l=o||a,c=e=>l&&(0===this._highlightGroups.size||o&&!!n&&!e.has(n));if(c(this._highlightGroups))return null;const h=t===ie.H_.ShadowExcludeHighlight,d=!(l||h);for(const{buffers:p}of this._dataByOrigin.values())for(const r of p){var u,f;if(c(r.highlightGroups))continue;const o=a?r.drawCommandsHighlights.size>0:l?n?r.drawCommandsHighlights.get(n):r.drawCommandsHighlights.size>0:null!==(u=null===(f=(h&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)||void 0===f?void 0:f.length)&&void 0!==u&&u,p=d&&r.drawCommandsOccludees||null;if(o||null!==p&&void 0!==p&&p.length){const r=this._glMaterials.load(e.rctx,s,t),n=null===r||void 0===r?void 0:r.beginSlot(i);if(n)return n}}return null}render(e,t){const{output:i,bind:r}=e,{slot:n,highlightGroupName:s}=r,a=i===ie.H_.Highlight;if(a&&!s)return;const o=i===ie.H_.ShadowHighlight,l=a||o,c=i===ie.H_.ShadowExcludeHighlight,h=!(l||c),d=n===ce.r.OCCLUDER_MATERIAL||n===ce.r.TRANSPARENT_OCCLUDER_MATERIAL?n:null,{rctx:u}=e;u.runAppleAmdDriverHelper();const f=u.bindTechnique(t,r,this.material.parameters);for(const g of this._dataByOrigin.values())for(const e of g.buffers){var p;if(a&&(!e.hasHighlights||!e.drawCommandsHighlights.has(s)))continue;if(o&&!e.hasHighlights)continue;const i=()=>{const t=[];for(const i of e.drawCommandsHighlights.values())t.push(i);return t},n=l&&!o&&null!==(p=e.drawCommandsHighlights.get(s))&&void 0!==p?p:null,_=o?i():l?n?[n]:je:(c&&e.needsMultipleCommands()?[e.drawCommandsShadowHighlightRest]:[e.drawCommandsDefault])||je,m=_.some((e=>e.length>0)),v=h&&e.drawCommandsOccludees||null;if(m||null!==v&&void 0!==v&&v.length){if(this._drawParameters.origin=g.origin,f.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(e.vao),u.bindVAO(e.vao),m)for(const e of _)u.setPipelineState(t.getPipeline(!1,d)),e.forAll((e=>u.drawArrays(t.primitiveType,e.first,e.count)));(null===v||void 0===v?void 0:v.length)&&(u.setPipelineState(t.getPipeline(!0,d)),v.forAll((e=>u.drawArrays(t.primitiveType,e.first,e.count))))}}}get test(){}};(0,r._)([(0,o.Cb)({constructOnly:!0})],Ee.prototype,"material",void 0),Ee=(0,r._)([(0,h.j)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Ee);class Ae{constructor(e){this.origin=e,this.changes=new Array}}function Me(e,t){const i=e.find((e=>e.numElements>=t));if(null==i)return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const De=(0,ye.Ue)(),Fe=(0,ye.Ue)(),Pe=new _e.Z({allocator:e=>e||new xe,deallocator:null}),Le=65536,Be=4*Le,Ne=1024,Ue=16777216,He=Ue/4;let ze=new Float32Array(Le);function Ge(e){return ze.length<e&&(ze=new Float32Array(e)),ze}function Ve(e){const t=4*e;return t<=Ne?Ne:t<Be?(0,J.Sf)(t):Math.max(Math.min(Math.ceil(1.5*t/Be)*Be,Ue),t)}const je=[];let Ze=class extends se{constructor(e){super(e),this._hasHighlights=!1,this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new de,this._bufferWriter=null}get produces(){return this._produces}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!!(t!==ie.H_.Highlight&&t!==ie.H_.ShadowHighlight||this._hasHighlights)&&e(t)))}))}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometry(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:i,bind:r}=e,n=t.produces.get(r.slot);if(null===n||void 0===n||!n(i))return null;if((i===ie.H_.Highlight||i===ie.H_.ShadowHighlight)&&!this._hasHighlights)return null;const s=this._glMaterials.load(e.rctx,r.slot,i);return null===s||void 0===s?void 0:s.beginSlot(r)}render(e,t){const i=this._renderGeometries;if(0===i.size)return;const{bind:r}=e,n=r.slot===ce.r.OCCLUDER_MATERIAL||r.slot===ce.r.TRANSPARENT_OCCLUDER_MATERIAL?r.slot:null,s=e.rctx;s.runAppleAmdDriverHelper(),s.bindTechnique(t,r,this.material.parameters);const a=t.program;for(const[o,l]of i)this._drawParameters.origin=l.localOrigin,a.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(l.vao),s.bindVAO(l.vao),s.setPipelineState(t.getPipeline(!1,n)),s.drawArrays(t.primitiveType,0,l.numElements)}initializeRenderContext(e,t){this._glMaterials=new le(this.material,e.materials);const i=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,te.K)(this._bufferWriter.vertexBufferLayout));this._vaoCache=i}uninitializeRenderContext(){}addRenderGeometry(e,t,i){this.removeRenderGeometry(e);const r=this._bufferWriter.vertexBufferLayout.stride,n=this._vaoCache.newVao(Ve(t.data.byteLength));n.vertexBuffers.get("geometry").setSubData(new Uint8Array(t.data),0,0,t.elementCount*r);const s={localOrigin:i,vao:n,numElements:t.elementCount};return this._renderGeometries.set(e,s),s}removeRenderGeometry(e){const t=this._renderGeometries.get(e);null!=t&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}};(0,r._)([(0,o.Cb)({constructOnly:!0})],Ze.prototype,"material",void 0),Ze=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],Ze);var Ye,qe,ke,We=i(4760),Xe=i(77427),Je=i(32035),Qe=i(55158),Ke=i(17842),$e=i(19093),et=i(53548),tt=i(40885),it=i(40927);!function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"}(Ye||(Ye={})),function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(qe||(qe={}));let rt=ke=class extends p.Z{constructor(e){super(e),this._ray=(0,tt.Ue)(),this._viewport=(0,k.al)(0,0,1,1),this._padding=(0,k.al)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,X.al)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,ye.Ue)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,ye.Ue)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,ye.Ue)(),this._frustumDirty=!0,this._frustum=(0,et.Ue)(),this._fullViewport=(0,k.Ue)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,M.Ue)(),this._up=(0,M.Ue)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,Je.d)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,ve.JG)(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,Je.i)((0,M.Ue)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,Je.i)((0,M.Ue)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,Je.i)((0,M.Ue)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,$e.d)((0,k.Ue)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,$e.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,$e.d)((0,k.Ue)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,$e.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[qe.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[qe.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[qe.RIGHT]+this._padding[qe.LEFT]}set fullWidth(e){this.width=e-(this._padding[qe.RIGHT]+this._padding[qe.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[qe.TOP]+this._padding[qe.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[qe.TOP]+this._padding[qe.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[qe.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[qe.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,$e.a)(this._padding,e)||(this._viewport[0]+=e[qe.LEFT]-this._padding[qe.LEFT],this._viewport[1]+=e[qe.BOTTOM]-this._padding[qe.BOTTOM],this._viewport[2]-=e[qe.RIGHT]+e[qe.LEFT]-(this._padding[qe.RIGHT]+this._padding[qe.LEFT]),this._viewport[3]-=e[qe.TOP]+e[qe.BOTTOM]-(this._padding[qe.TOP]+this._padding[qe.BOTTOM]),(0,$e.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,ve.Jp)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return(0,ve.U_)((0,ye.Ue)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,ye.Ue)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovX(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovY(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,Je.j)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,ve.U_)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,ve.p4)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,n=i/this.rows,s=r/this.columns,a=-r/2+this.column*s,o=a+s,l=-i/2+this.row*n,c=l+n,h=(0,ve.oy)((0,ye.Ue)(),a*(1+2*this._padding[qe.LEFT]/e),o*(1+2*this._padding[qe.RIGHT]/e),l*(1+2*this._padding[qe.BOTTOM]/t),c*(1+2*this._padding[qe.TOP]/t),this.near,this.far),d=this._get("projectionMatrix");return d&&(0,ve.fS)(d,h)?d:h}copyFrom(e){(0,Je.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,$e.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,$e.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,W.JG)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,ve.JG)(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,et.JG)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,ve.JG)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,$e.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return(new ke).copyFrom(this)}equals(e){return(0,Je.p)(this.eye,e.eye)&&(0,Je.p)(this.center,e.center)&&(0,Je.p)(this.up,e.up)&&(0,$e.a)(this._viewport,e.viewport)&&(0,$e.a)(this._padding,e.padding)&&(0,W.I6)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,$e.f)(e.screenPadding,this.screenPadding)>=t||(0,$e.f)(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;(0,Je.a)(ot,e.eye,e.center),(0,Je.a)(lt,this.eye,this.center);const i=(0,Je.f)(ot,lt),r=(0,Je.z)(ot),n=(0,Je.z)(lt),s=5e-4;return i*i>=(1-1e-10)*r*n&&(0,Je.y)(e.eye,this.eye)<Math.max(r,n)*s*s}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,it.SR)(this.viewForward,(0,Je.d)(ot,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Ke.s1)();return e[0]=(this.padding[qe.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[qe.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e[0]=this.padding[qe.LEFT]+this.width*t,e[1]=this.padding[qe.BOTTOM]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t){e!==st&&(0,Je.c)(st,e),st[3]=1,(0,$e.t)(st,st,this.projectionMatrix);const i=Math.abs(st[3]);(0,Je.h)(st,st,1/i);const r=this.fullViewport;t[0]=(0,J.t7)(0,r[0]+r[2],.5+.5*st[0]),t[1]=(0,J.t7)(0,r[1]+r[3],.5+.5*st[1]),t[2]=.5*(st[2]+1),t[3]=i}unapplyProjection(e,t){const i=this.fullViewport;st[0]=(e[0]/(i[0]+i[2])*2-1)*e[3],st[1]=(e[1]/(i[1]+i[3])*2-1)*e[3],st[2]=(2*e[2]-1)*e[3],st[3]=e[3],null!=this.inverseProjectionMatrix&&((0,$e.t)(st,st,this.inverseProjectionMatrix),t[0]=st[0],t[1]=st[1],t[2]=st[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,ct),this.renderToScreen(ct,t),t}projectToRenderScreen(e,t){if(st[0]=e[0],st[1]=e[1],st[2]=e[2],st[3]=1,(0,$e.t)(st,st,this.viewProjectionMatrix),0===st[3])return null;const i=st;(0,Je.h)(i,i,1/Math.abs(st[3]));const r=this.fullViewport,n=(0,J.t7)(0,r[0]+r[2],.5+.5*i[0]),s=(0,J.t7)(0,r[1]+r[3],.5+.5*i[1]);return"x"in t?(t.x=n,t.y=s):(t[0]=n,t[1]=s,t.length>2&&(t[2]=.5*(i[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,ct),t)}unprojectFromRenderScreen(e,t){if((0,ve.Jp)(at,this.projectionMatrix,this.viewMatrix),!(0,ve.U_)(at,at))return null;const i=this.fullViewport;return st[0]=2*(e[0]-i[0])/i[2]-1,st[1]=2*(e[1]-i[1])/i[3]-1,st[2]=2*e[2]-1,st[3]=1,(0,$e.t)(st,st,at),0===st[3]?null:(t[0]=st[0]/st[3],t[1]=st[1]/st[3],t[2]=st[2]/st[3],t)}constrainWindowSize(e,t,i,r){const n=e*this.pixelRatio,s=t*this.pixelRatio,a=Math.max(n-i/2,0),o=Math.max(this.fullHeight-s-r/2,0),l=-Math.min(n-i/2,0),c=-Math.min(this.fullHeight-s-r/2,0),h=i-l- -Math.min(this.fullWidth-n-i/2,0),d=r-c- -Math.min(s-r/2,0);return[Math.round(a),Math.round(o),Math.round(h),Math.round(d)]}computeUp(e){e===j.JY.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){(0,Je.d)(ot,this.center,this.eye);const e=(0,Je.l)(this.center);e<1?((0,Je.i)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,Je.f)(ot,this.center))>.9999*(0,Je.l)(ot)*e||((0,Je.e)(this._up,ot,this.center),(0,Je.e)(this._up,this._up,ot),(0,Je.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,Je.o)(ot,this.eye,this.center),Math.abs(ot[2])<=.9999&&((0,Je.h)(ot,ot,ot[2]),(0,Je.i)(this._up,-ot[0],-ot[1],1-ot[2]),(0,Je.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,Je.p)(e,t)||((0,Je.c)(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):c.Z.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,et.q_)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,ve.zB)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,r._)([(0,o.Cb)()],rt.prototype,"_viewport",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_padding",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_fov",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_nearFar",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_viewDirty",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_viewMatrix",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_pixelRatio",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"pixelRatio",null),(0,r._)([(0,o.Cb)()],rt.prototype,"row",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"column",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"_rows",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"rows",null),(0,r._)([(0,o.Cb)()],rt.prototype,"_columns",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"columns",null),(0,r._)([(0,o.Cb)()],rt.prototype,"eye",null),(0,r._)([(0,o.Cb)()],rt.prototype,"center",null),(0,r._)([(0,o.Cb)()],rt.prototype,"_center",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"up",null),(0,r._)([(0,o.Cb)()],rt.prototype,"_up",void 0),(0,r._)([(0,o.Cb)()],rt.prototype,"viewMatrix",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"viewForward",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"viewUp",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"viewRight",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"nearFar",null),(0,r._)([(0,o.Cb)()],rt.prototype,"near",null),(0,r._)([(0,o.Cb)()],rt.prototype,"far",null),(0,r._)([(0,o.Cb)()],rt.prototype,"viewport",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"screenViewport",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"screenPadding",null),(0,r._)([(0,o.Cb)()],rt.prototype,"x",null),(0,r._)([(0,o.Cb)()],rt.prototype,"y",null),(0,r._)([(0,o.Cb)()],rt.prototype,"width",null),(0,r._)([(0,o.Cb)()],rt.prototype,"height",null),(0,r._)([(0,o.Cb)()],rt.prototype,"fullWidth",null),(0,r._)([(0,o.Cb)()],rt.prototype,"fullHeight",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"_aspect",null),(0,r._)([(0,o.Cb)()],rt.prototype,"padding",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"projectionMatrix",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"inverseProjectionMatrix",null),(0,r._)([(0,o.Cb)()],rt.prototype,"fov",null),(0,r._)([(0,o.Cb)()],rt.prototype,"fovX",null),(0,r._)([(0,o.Cb)()],rt.prototype,"fovY",null),(0,r._)([(0,o.Cb)()],rt.prototype,"viewInverseTransposeMatrix",null),(0,r._)([(0,o.Cb)({readOnly:!0})],rt.prototype,"_projectionMatrixInternal",null),(0,r._)([(0,o.Cb)()],rt.prototype,"relativeElevation",void 0),rt=ke=(0,r._)([(0,h.j)("esri.views.3d.webgl.RenderCamera")],rt);const nt=rt,st=(0,k.Ue)(),at=(0,ye.Ue)(),ot=(0,M.Ue)(),lt=(0,M.Ue)(),ct=(0,Ke.J$)();var ht=i(7566),dt=i(54463),ut=i(78329),ft=i(29303),pt=i(21389),gt=i(25158),_t=i(80064),mt=i(44070),vt=i(8548);class yt{constructor(e,t,i){this._elementSize=t,this._buffer=mt.f.createVertex(e,vt.l1.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const n=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}}class wt{constructor(e){this.modelOriginHi=e.getField(We.T.INSTANCEMODELORIGINHI,gt.ct),this.modelOriginLo=e.getField(We.T.INSTANCEMODELORIGINLO,gt.ct),this.model=e.getField(We.T.INSTANCEMODEL,gt.gK),this.modelNormal=e.getField(We.T.INSTANCEMODELNORMAL,gt.gK),this.featureAttribute=e.getField(We.T.INSTANCEFEATUREATTRIBUTE,gt.ek),this.color=e.getField(We.T.INSTANCECOLOR,gt.mc),this.objectAndLayerIdColor=e.getField(We.T.INSTANCEOBJECTANDLAYERIDCOLOR,gt.mc)}}class xt{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var e,t;return null!==(e=null===(t=this._buffer)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,we.hu)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,we.hu)(this._updating,"not updating"),this.size<pe.p$*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,we.hu)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,we.hu)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,we.hu)(this._updating,"not updating"),(0,we.hu)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(bt,Math.floor(this._capacity*pe._x));this._resize(e)}_shrink(){const e=Math.max(bt,Math.floor(this._capacity*pe.$L));this._resize(e)}_resize(e){if((0,we.hu)(this._updating,"not updating"),e===this._capacity)return;const t=new yt(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this._compactInstances(t);(0,we.hu)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new wt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const bt=64;var Tt;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(Tt||(Tt={}));class Ct{constructor(e){this.localTransform=e.getField(We.T.LOCALTRANSFORM,gt.O1),this.globalTransform=e.getField(We.T.GLOBALTRANSFORM,gt.O1),this.modelOrigin=e.getField(We.T.MODELORIGIN,gt.fP),this.model=e.getField(We.T.INSTANCEMODEL,gt.gK),this.modelNormal=e.getField(We.T.INSTANCEMODELNORMAL,gt.gK),this.modelScaleFactors=e.getField(We.T.MODELSCALEFACTORS,gt.Eu),this.boundingSphere=e.getField(We.T.BOUNDINGSPHERE,gt.Cd),this.featureAttribute=e.getField(We.T.FEATUREATTRIBUTE,gt.ek),this.color=e.getField(We.T.COLOR,gt.mc),this.objectAndLayerIdColor=e.getField(We.T.OBJECTANDLAYERIDCOLOR,gt.mc),this.state=e.getField(We.T.STATE,gt.D_),this.lodLevel=e.getField(We.T.LODLEVEL,gt.D_)}}let St=class extends p.Z{constructor(e,t){super(e),this.events=new n.Z,this._capacity=0,this._size=0,this._next=0,this._highlightGroupMap=new Map,this._highlightGroupMapPrev=new Map,this._layout=function(e){let t=(0,Qe.U$)().mat4f64(We.T.LOCALTRANSFORM).mat4f64(We.T.GLOBALTRANSFORM).vec4f64(We.T.BOUNDINGSPHERE).vec3f64(We.T.MODELORIGIN).mat3f(We.T.INSTANCEMODEL).mat3f(We.T.INSTANCEMODELNORMAL).vec2f(We.T.MODELSCALEFACTORS);return e.includes(We.T.FEATUREATTRIBUTE)&&(t=t.vec4f(We.T.FEATUREATTRIBUTE)),e.includes(We.T.COLOR)&&(t=t.vec4u8(We.T.COLOR)),e.includes(We.T.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(We.T.OBJECTANDLAYERIDCOLOR)),t=t.u8(We.T.STATE).u8(We.T.LODLEVEL),t}(t),this._capacity=bt,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Ct(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,Tt.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;(0,we.hu)(e>=0&&e<this._capacity&&!!(t.get(e)&Tt.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,Tt.ACTIVE)?this._setStateFlags(e,Tt.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,we.hu)(e>=0&&e<this._capacity&&!!(t.get(e)&Tt.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=It,r=Rt;t.localTransform.getMat(e,Ot),t.globalTransform.getMat(e,Et);const n=(0,ve.Jp)(Et,Et,Ot);(0,Je.i)(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),(0,ft.xO)(r,n),t.model.setMat(e,r);const s=(0,_t.mw)(It,n);s.sort(),t.modelScaleFactors.set(e,0,s[1]),t.modelScaleFactors.set(e,1,s[2]),(0,ft.U_)(r,r),(0,ft.p4)(r,r),t.modelNormal.setMat(e,r),this._setStateFlags(e,Tt.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,Rt),i.modelOrigin.getVec(e,It),t[0]=Rt[0],t[1]=Rt[1],t[2]=Rt[2],t[3]=0,t[4]=Rt[3],t[5]=Rt[4],t[6]=Rt[5],t[7]=0,t[8]=Rt[6],t[9]=Rt[7],t[10]=Rt[8],t[11]=0,t[12]=It[0],t[13]=It[1],t[14]=It[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(It,this,e),t*=Math.max(It[0],It[1],It[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(It,this,e),t*=function(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}(It[0],It[1],It[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,Tt.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,Tt.VISIBLE)}setHighlight(e,t,i){var r;let n=this._highlightGroupMap.get(e);t?(n||(n=new Set,this._highlightGroupMap.set(e,n)),n.add(i)&&(this._setStateFlag(e,Tt.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed"))):(null===(r=n)||void 0===r?void 0:r.delete(i))&&(0===n.size&&(this._highlightGroupMap.delete(e),this._setStateFlag(e,Tt.HIGHLIGHT,!1)),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,Tt.HIGHLIGHT)}foreachHighlightGroupPrev(e,t){var i;null!==(i=this._highlightGroupMapPrev.get(e))&&void 0!==i&&i.forEach(t),this._highlightGroupMapPrev.delete(e)}foreachHighlightGroup(e,t){const i=this._highlightGroupMap.get(e);null!==i&&void 0!==i&&i.forEach(t),i?this._highlightGroupMapPrev.set(e,new Set(i)):this._highlightGroupMapPrev.delete(e)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(bt,Math.floor(this._capacity*pe._x)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Ct(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&Tt.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,r._)([(0,o.Cb)({constructOnly:!0})],St.prototype,"shaderTransformation",void 0),(0,r._)([(0,o.Cb)()],St.prototype,"_size",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],St.prototype,"size",null),St=(0,r._)([(0,h.j)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],St);const It=(0,M.Ue)(),Rt=(0,pt.Ue)(),Ot=(0,ye.Ue)(),Et=(0,ye.Ue)();var At=i(83479);class Mt extends ut.Z{constructor(e,t){super((e=>(0,At.w)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,At.c)(),this._tmpMat4=(0,ye.Ue)()}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,Je.t)((0,At.a)(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,_t.u1)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Dt{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){const r=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*t/r;let s=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(s=a);return s}}var Ft=i(1395),Pt=(i(55848),i(22178));i(76783);class Lt{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,Je.h)(Bt,this.ray.direction,this.dist),(0,Je.l)(Bt)):null}getIntersectionPoint(e){return!!(0,Pt.nn)(this)&&((0,Je.h)(Bt,this.ray.direction,this.dist),(0,Je.g)(e,this.ray.origin,Bt),!0)}getTransformedNormal(e){return(0,Je.c)(Nt,this.normal),Nt[3]=0,(0,$e.t)(Nt,Nt,this.transformation),(0,Je.c)(e,Nt),(0,Je.n)(e,e)}constructor(e){this.intersector=dt.q7.OBJECT,this.normal=(0,M.Ue)(),this.transformation=(0,ye.Ue)(),this._ray=(0,tt.Ue)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=dt.q7.OBJECT,(0,tt.JG)(e,this._ray)}set(e,t,i,r,n,s,a){this.intersector=e,this.dist=i,(0,Je.c)(this.normal,null!==r&&void 0!==r?r:M.eG),(0,ve.JG)(this.transformation,null!==n&&void 0!==n?n:ye.Wd),this.target=t,this.drapedLayerOrder=s,this.drapedLayerGraphicOrder=a}copy(e){(0,tt.JG)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,Je.c)(this.normal,e.normal),(0,ve.JG)(this.transformation,e.transformation)}}const Bt=(0,M.Ue)(),Nt=(0,k.Ue)();var Ut=i(45412);class Ht extends Ut.U{}var zt=i(22255);class Gt{constructor(e,t){const i=e.renderContext.rctx,r=t.geometry;let n=null;n=r instanceof Ft.c?function(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const n=e.createBufferWriter(),s=n.vertexBufferLayout,a=n.elementCount(t),o=s.createBuffer(a);return n.write(null,null,t,r,o,0),{material:e,vertexBufferLayout:s,buffer:o.buffer,elementCount:a,boundingInfo:i}}(r.material,r.attributes,r.boundingInfo):r;const s=n.material;this._materials=e.materials,s.setParameters({instancedDoublePrecision:!0}),this.geometry=r,this.material=s,this.glMaterials=new le(s,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=mt.f.createVertex(i,vt.l1.STATIC_DRAW,n.buffer),this.vao=new Ht(i,ht.i,new Map([["geometry",(0,te.K)(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,n,s,a,o){if(!(this.geometry instanceof Ft.c))return;const l=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,r,((i,r,c,h,d)=>{if(i>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,i))return;const h=new zt.x(s.layerUid,s.graphicUid(n),l,c,a,o);if((null==e.results.min.drapedLayerOrder||d>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&e.results.min.set(dt.q7.LOD,h,i,r,e.transform.transform,d),e.options.store!==dt.eC.MIN&&(null==e.results.max.drapedLayerOrder||d>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&e.results.max.set(dt.q7.LOD,h,i,r,e.transform.transform,d),e.options.store===dt.eC.ALL){const t=function(e){return new Lt(e)}(e.results.min.ray);t.set(dt.q7.LOD,h,i,r,e.transform.transform,d),e.results.all.push(t)}}}))}}class Vt{static async create(e,t,i){const r=await Promise.allSettled(t.components.map((t=>e.controller.schedule((()=>new Gt(e,t)),i)))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(pe.pC);if((0,s.Hc)(i)||n.length!==r.length){n.forEach((e=>e.destroy())),(0,s.k_)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new Vt(t.minScreenSpaceRadius,n)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,i,r,n,s,a){this.components.forEach((o=>o.intersect(e,t,i,r,n,s,this.boundingSphere,a)))}get boundingBox(){if(null==this._boundingBox){const e=(0,D.cS)();this.components.forEach((t=>{null!=t.boundingInfo&&((0,D.pp)(e,t.boundingInfo.bbMin),(0,D.pp)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,M.Ue)();(0,D.be)(e,t),this._boundingSphere={center:t,radius:.5*(0,D.wz)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}var jt=i(22909),Zt=i(43411);const Yt=(0,M.Ue)(),qt=new Float32Array(6);var kt=i(56081),Wt=i(96638),Xt=i(3384);let Jt=class extends ae{constructor(e,t){super(e),this.type=dt.q7.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new nt,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[ce.r.OPAQUE_MATERIAL,e=>this._produces(e)],[ce.r.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new St({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(Wt.T8.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=(0,Qe.U$)().vec3f(We.T.INSTANCEMODELORIGINHI).vec3f(We.T.INSTANCEMODELORIGINLO).mat3f(We.T.INSTANCEMODEL).mat3f(We.T.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(We.T.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(We.T.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(We.T.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,te.K)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(e=>{let{index:t}=e;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)})),this._instanceData.events.on("instance-visibility-changed",(e=>{let{index:t}=e;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this.baseMaterial.hasEmissions}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),0)}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*n,trianglesPerInstance:n})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}_createRenderInstanceDataArray(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const{rctx:t}=this._context.renderContext;return this.symbol.levels.map((i=>{e.push(new xt(t,this._instanceBufferLayout))})),e}async initializeRenderContext(e,t){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const i=await Promise.allSettled(this.symbol.levels.map((i=>Vt.create(e,i,t)))),r=i.map((e=>"fulfilled"===e.status?e.value:null)).filter(pe.pC);if((0,s.Hc)(t)||r.length!==i.length){r.forEach((e=>e.destroy())),(0,s.k_)(t);for(const e of i)if("rejected"===e.status)throw e.reason}this._levels=r,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new Dt(t,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceDataMap.forEach((e=>e.forEach((e=>e.destroy()))))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(ce.r.TRANSPARENT_MATERIAL);return null===t||void 0===t?void 0:t(ie.H_.Color)}))))}hasHighlights(){return(0,Xe.oE)(this._highlightRenderInstanceDataMap,(e=>e.some((e=>e.size>0))))}_produces(e){return e!==ie.H_.Highlight&&e!==ie.H_.ShadowHighlight||this.hasHighlights()}prepareRender(e){if(!Q.h.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Wt.G5),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const i=new Array,r=this.levels;return t.forEach((t=>r.forEach(((r,n)=>{let{components:s}=r;return s.forEach((r=>i.push(this._beginComponent(e,t[n],r))))})))),i}render(e,t){const i=this._getInstanceDatas(e);if(!i||null==t)return;let r=0;e.rctx.bindVAO();const n=this.levels;i.forEach((i=>n.forEach(((n,s)=>{let{components:a}=n;return a.forEach((n=>this._renderComponent(e,t[r++],i[s],n,s)))}))))}_getInstanceDatas(e){const{output:t,bind:i}=e,r=t===ie.H_.Highlight,n=!r&&t!==ie.H_.ShadowHighlight,s=t!==ie.H_.ShadowExcludeHighlight;if(n)return s?this._allRenderInstanceData:[this._defaultRenderInstanceData];if(s){if(r){const{highlightGroupName:e}=i;if(!e)return null;const t=this._highlightRenderInstanceDataMap.get(e);return t?[t]:null}const e=[];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}return null}intersect(e,t,i,r){if(!this.baseMaterial.visible||null==this._octree)return;const n=(0,M.Ue)();(0,Je.d)(n,r,i);const s=n=>{this._instanceData.getCombinedModelTransform(n,ei),e.transform.set(ei),(0,Je.t)(ti,i,e.transform.inverse),(0,Je.t)(ii,r,e.transform.inverse);const s=this._instanceData.getState(n),a=this._instanceData.getLodLevel(n),o=this._levels.length;(0,we.hu)(!!(s&Tt.ACTIVE),"invalid instance state"),(0,we.hu)(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(e,t,ti,ii,n,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(s):this._octree.forEachAlongRay(i,n,s)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var e;const t=this._instanceData,i=null===(e=t.view)||void 0===e?void 0:e.state;if(!i)return null;this._octreeCached=new Mt(t,this.baseBoundingSphere);for(let e=0;e<t.capacity;++e)i.get(e)&Tt.ACTIVE&&this._octreeCached.addInstance(e)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,q.SC)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return{near:1/0,far:-1/0};const t=e.viewForward,i=this._octree.findClosest(t,ut.Z.DepthOrder.FRONT_TO_BACK,e.frustum),r=this._octree.findClosest(t,ut.Z.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==i||null==r)return{near:1/0,far:-1/0};const n=e.eye,s=this._instanceData.view;s.boundingSphere.getVec(i,$t),(0,Je.d)($t,$t,n);const a=(0,Je.f)($t,t)-$t[3];s.boundingSphere.getVec(r,$t),(0,Je.d)($t,$t,n);const o=(0,Je.f)($t,t)+$t[3];return{near:Math.max(e.near,a),far:Math.min(e.far,o)}}_requestUpdateCycle(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:r}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const n=this._instanceData,s=n.view;let a=n.size;const o=n.capacity;let l=this._instanceIndex;const c=Math.ceil(o/500);for(let h=0;h<a&&!e.done;++h){l===this._cycleStartIndex&&this._startUpdateCycle();const h=s.state.get(l);let d=0;if(!(h&Tt.ALLOCATED)){l=l+1===o?0:l+1,a++;continue}const u=s.lodLevel.get(l);if(h&Tt.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[u].freeTail(),h&Tt.HIGHLIGHT_ACTIVE&&n.foreachHighlightGroupPrev(l,(e=>{const t=this._highlightRenderInstanceDataMap.get(e);if(!t)throw new E.Z("Internal error in lodRenderer");t[u].freeTail()})),h&Tt.REMOVE)n.freeInstance(l);else if(h&Tt.VISIBLE){let e=0;t&&(s.modelOrigin.getVec(l,Kt),e=r.selectLevel(Kt,n.getCombinedMedianScaleFactor(l),i)),d=h&~(Tt.ACTIVE|Tt.TRANSFORM_CHANGED),e>=0&&(h&Tt.HIGHLIGHT?(n.foreachHighlightGroup(l,(t=>{let i=this._highlightRenderInstanceDataMap.get(t);if(i||(i=this._createRenderInstanceDataArray(),i.forEach((e=>e.beginUpdate())),this._highlightRenderInstanceDataMap.set(t,i)),e>=i.length)throw new E.Z("LodRenderer internal error - missing lodLevel ".concat(e));Qt(i[e],s,l)})),d|=Tt.HIGHLIGHT_ACTIVE):(Qt(this._defaultRenderInstanceData[e],s,l),d|=Tt.DEFAULT_ACTIVE)),s.state.set(l,d),s.lodLevel.set(l,e)}else d=h&~(Tt.ACTIVE|Tt.TRANSFORM_CHANGED),s.state.set(l,d);if(null!=this._octreeCached){const e=!!(h&Tt.ACTIVE),t=!!(d&Tt.ACTIVE);!e&&t?this._octreeCached.addInstance(l):e&&!t?this._octreeCached.removeInstance(l):e&&t&&h&Tt.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===o?0:l+1,l%c==0&&e.madeProgress()}this._instanceIndex=l,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,i){if(0===t.size)return null;const r=i.glMaterials.load(e.rctx,e.bind.slot,e.output);return null===r||void 0===r?void 0:r.beginSlot(e.bind)}_renderComponent(e,t,i,r,n){if(!t)return;const{bind:s,rctx:a}=e;a.runAppleAmdDriverHelper();const o=a.bindTechnique(t,s,r.material.parameters,ni);a.bindVAO(r.vao),t.ensureAttributeLocations(r.vao),Q.h.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===ie.H_.Color&&(o.setUniform4fv("externalColor",ri[Math.min(n,ri.length-1)]),o.setUniform1i("colorMixMode",jt.FZ.replace));const l=i.capacity,c=i.headIndex,h=i.tailIndex,d=i.firstIndex,u=this._glInstanceBufferLayout,f=(e,n)=>{(0,Xt.XP)(a,ht.i,i.buffer,u,e),a.drawArraysInstanced(t.primitiveType,0,r.vertexCount,n-e),(0,Xt.UF)(a,ht.i,i.buffer,u)};r.material.parameters.transparent&&null!=d?c>h?((0,we.hu)(d>=h&&d<=c,"invalid firstIndex"),f(d,c),f(h,d)):c<h&&(d<=c?((0,we.hu)(d>=0&&d<=c,"invalid firstIndex"),f(d,c),f(h,l),f(0,d)):((0,we.hu)(d>=h&&d<=l,"invalid firstIndex"),f(d,l),f(0,c),f(h,d))):c>h?f(h,c):c<h&&(f(0,c),f(h,l)),a.bindVAO(null)}};function Qt(e,t,i){const r=e.allocateHead();!function(e,t,i,r){(function(e,t,i,r,n){Yt[0]=e.get(t,0),Yt[1]=e.get(t,1),Yt[2]=e.get(t,2),(0,Zt.LF)(Yt,qt,3),i.set(n,0,qt[0]),r.set(n,0,qt[1]),i.set(n,1,qt[2]),r.set(n,1,qt[3]),i.set(n,2,qt[4]),r.set(n,2,qt[5])})(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(r,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}(0,r._)([(0,o.Cb)({constructOnly:!0})],Jt.prototype,"symbol",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],Jt.prototype,"optionalFields",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],Jt.prototype,"metadata",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],Jt.prototype,"shaderTransformation",void 0),(0,r._)([(0,o.Cb)()],Jt.prototype,"_instanceData",void 0),(0,r._)([(0,o.Cb)()],Jt.prototype,"_cycleStartIndex",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],Jt.prototype,"_enableLevelSelection",null),(0,r._)([(0,o.Cb)()],Jt.prototype,"_updateCyclesWithStaticCamera",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],Jt.prototype,"running",null),Jt=(0,r._)([(0,h.j)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Jt);const Kt=(0,M.Ue)(),$t=(0,k.Ue)(),ei=(0,ye.Ue)(),ti=(0,M.Ue)(),ii=(0,M.Ue)(),ri=[(0,k.al)(1,0,1,1),(0,k.al)(0,0,1,1),(0,k.al)(0,1,0,1),(0,k.al)(1,1,0,1),(0,k.al)(1,0,0,1)],ni=new kt.Qm;class si{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.geometry=e,this.textures=t}get material(){return this.geometry.material}get numTriangles(){return this.geometry instanceof Ft.c?this.geometry.indexCount/3:this.geometry.elementCount/3}}class ai{constructor(e,t,i){this.components=e,this.minScreenSpaceRadius=t,this.pivotOffset=i;const r=(0,pe.Tw)(this.components.map((e=>e.geometry)));this.numVertices=r.reduce(((e,t)=>e+function(e){return e instanceof Ft.c?e.attributes.get(We.T.POSITION).indices.length:e.elementCount}(t)),0)}}class oi{constructor(e){this.levels=e,this.levels.sort(((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius))}}let li=class{constructor(e){this._optionalFields=new Array,this._instanceIndexToFeatureId=new Map,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}async doLoad(e,t,i){(0,l.Z)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(We.T.OBJECTANDLAYERIDCOLOR);const r=function(e,t){const i=t.levels.map((t=>{const i=t.components.map((t=>{const i=e(t.materialId);if(!function(e){return null!=e&&"materialType"in e&&"default"===e.materialType}(i))throw new Error("LodRenderer only supports DefaultMaterial");const r=i.createBufferWriter(),n={material:i,vertexBufferLayout:r.vertexBufferLayout,buffer:t.renderGeometryBuffer.data,elementCount:t.renderGeometryBuffer.elementCount,boundingInfo:t.boundingInfo};return new si(n)}));return new ai(i,t.minScreenSpaceRadius)}));return new oi(i)}((e=>t(e)),e),n=this.view._stage,a=function(e){const t=[];return e.levels.forEach((e=>e.components.forEach((e=>t.push(e.geometry.material))))),(0,pe.Tw)(t)}(r);n.addMany(a),this._addDisposeResource((()=>n.removeMany(a)));const o=function(e){const t=new Array;return e.levels.forEach((e=>e.components.forEach((e=>{null!=e.textures&&t.push(...e.textures)})))),(0,pe.Tw)(t)}(r);n.addMany(o),this._addDisposeResource((()=>{o.forEach((e=>e.unload())),n.removeMany(o)})),await Promise.all(o.map((e=>this.view._stage.schedule((()=>e.load(n.renderView.renderingContext)),i)))),(0,s.k_)(i);const c=await this._createLodRenderer(r,i);this._lodRendererResources={lodRenderer:c,materials:a,textures:o}}addInstances(e){const t=this._lodRendererResources;if(null==t)return;const{featureIds:i,localTransforms:r,globalTransforms:n}=e,s=t.lodRenderer;if(null==s)return;const a=s.instanceData,o=i.length;for(let l=0;l<o;++l){const e=i[l],t=a.addInstance(),s=a.view,o=16*l;s.localTransform.copyFromTypedBuffer(t,r,o),s.globalTransform.copyFromTypedBuffer(t,n,o),a.updateModelTransform(t),a.setVisible(t,!0),this._instanceIndexToFeatureId.set(t,e),this._featureIdToInstanceIndex.set(e,t)}}removeInstances(e){const t=this._lodRendererResources;if(null==t)return;const i=(null===t||void 0===t?void 0:t.lodRenderer).instanceData,r=this._instanceIndexToFeatureId,n=this._featureIdToInstanceIndex,s=e.length;for(let a=0;a<s;++a){const t=e[a],s=n.get(t);null!=s&&(i.removeInstance(s),r.delete(s),n.delete(t))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,t){const i=this.view._stage,r={layerUid:this.layerUid,graphicUid:e=>1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},n=new Jt({symbol:e,optionalFields:this._optionalFields,metadata:r,shaderTransformation:null},this.scheduler);return n.slicePlaneEnabled=!1,this._addDisposeResource((()=>{i.removeRenderPlugin(n),n.destroy()})),await i.addRenderPlugin(n,t),n}};li=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],li);var ci=i(46228),hi=i(33586);const di=128,ui=.5;function fi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:di;const i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:di,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*ui,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(e){case"circle":default:return function(e,t){const i=e/2-.5;return vi(e,_i(i,i,t/2))}(t,i);case"square":return function(e,t){return pi(e,t,!1)}(t,i);case"cross":return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return gi(e,t,!1,i)}(t,i,r);case"x":return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return gi(e,t,!0,i)}(t,i,r);case"kite":return function(e,t){return pi(e,t,!0)}(t,i);case"triangle":return function(e,t){return vi(e,mi(e/2,t,t/2))}(t,i);case"arrow":return function(e,t){const i=t,r=t/2,n=e/2,s=.8*i,a=_i(n,(e-t)/2-s,Math.sqrt(s*s+r*r)),o=mi(n,i,r);return vi(e,((e,t)=>Math.max(o(e,t),-a(e,t))))}(t,i)}}(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*ui,arguments.length>3&&void 0!==arguments[3]?arguments[3]:0);return new hi.x(i,{mipmap:!1,wrap:{s:vt.e8.CLAMP_TO_EDGE,t:vt.e8.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function pi(e,t,i){return i&&(t/=Math.SQRT2),vi(e,((r,n)=>{let s=r-.5*e+.25,a=.5*e-n-.75;if(i){const e=(s+a)/Math.SQRT2;a=(a-s)/Math.SQRT2,s=e}return Math.max(Math.abs(s),Math.abs(a))-.5*t}))}function gi(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t-=r,i&&(t*=Math.SQRT2);const n=.5*t;return vi(e,((t,s)=>{let a,o=t-.5*e,l=.5*e-s-1;if(i){const e=(o+l)/Math.SQRT2;l=(l-o)/Math.SQRT2,o=e}return o=Math.abs(o),l=Math.abs(l),a=o>l?o>n?Math.sqrt((o-n)*(o-n)+l*l):l:l>n?Math.sqrt(o*o+(l-n)*(l-n)):o,a-=r/2,a}))}function _i(e,t,i){return(r,n)=>{const s=r-e,a=n-t;return Math.sqrt(s*s+a*a)-i}}function mi(e,t,i){const r=Math.sqrt(t*t+i*i);return(n,s)=>{const a=Math.abs(n-e)-i,o=s-e+t/2+.75,l=(t*a+i*o)/r,c=-o;return Math.max(l,c)}}function vi(e,t){const i=new Uint8Array(4*e*e);for(let r=0;r<e;r++)for(let n=0;n<e;n++){const s=n+e*r;let a=t(n,r);a=a/e+.5,(0,ci.I)(a,i,4*s)}return i}var yi=i(49335),wi=i(1413);function xi(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}var bi=i(66202),Ti=i(81879),Ci=i(26461),Si=i(45268),Ii=i(25278),Ri=i(56529),Oi=i(65216);class Ei{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var Ai=i(33236),Mi=i(83544),Di=i(82144),Fi=i(78914),Pi=i(14124),Li=i(78041),Bi=i(36207);class Ni extends Fi.A{constructor(e,t,r){super(e,t,new Di.J(Mi.H,(()=>i.e(6823).then(i.bind(i,16823)))),r),this.primitiveType=t.occlusionPass?vt.MX.POINTS:vt.MX.TRIANGLES}initializePipeline(e){const{oitPass:t,hasPolygonOffset:i,draped:r,output:n,depthTestEnabled:s}=e,a=t===Pi.M.NONE,o=i?Ui:null,l=t===Pi.M.ColorAlpha,c=r||!s||l||n===ie.H_.Highlight?null:Bi.ck;return(0,Bi.sm)({blending:n===ie.H_.Color?a?Bi.xW:(0,Li.j7)(t):null,depthTest:s&&!r?{func:vt.wb.LEQUAL}:null,depthWrite:c,drawBuffers:(0,Li.u_)(t,n),colorWrite:Bi.gf,polygonOffset:o})}}const Ui={factor:0,units:-4};var Hi=i(60113),zi=i(80848),Gi=i(5775),Vi=i(12085);class ji extends Vi.W{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.textureCoordinateType=Hi.I.None,this.emissionSource=zi.jo.None,this.discardInvisibleFragments=!0,this.hasSliceInVertexProgram=!0,this.hasVvInstancing=!1}}(0,r._)([(0,Gi.o)()],ji.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"signedDistanceFieldEnabled",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"vvSize",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"vvColor",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"hasRotation",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"debugDrawLabelBorder",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"hasSlicePlane",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"hasPolygonOffset",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"depthTestEnabled",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"pixelSnappingEnabled",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"draped",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"terrainDepthTest",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"cullAboveTerrain",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"occlusionPass",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"occludedFragmentFade",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,Gi.o)()],ji.prototype,"horizonCullingEnabled",void 0);class Zi extends Ri.F5{constructor(e,t){super(e,fr),this.produces=new Map([[ce.r.HUD_MATERIAL,e=>(0,ie.L_)(e)&&!this.parameters.drawInSecondSlot],[ce.r.LABEL_MATERIAL,e=>(0,ie.L_)(e)&&this.parameters.drawInSecondSlot],[ce.r.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[ce.r.DRAPED_MATERIAL,e=>this.parameters.draped&&(0,ie.L_)(e)]]),this._visible=!0,this._configuration=new ji(t)}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===ce.r.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.depthTestEnabled=this.parameters.depthEnabled||t.slot===ce.r.OCCLUSION_PIXELS,e===ie.H_.Color&&(this._configuration.debugDrawLabelBorder=!!Q.h.LABELS_SHOW_BORDER),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}intersect(e,t,i,r,n,s){const{options:{selectionMode:a,hud:o,excludeLabels:l},point:c,camera:h}=i,{parameters:d}=this;if(!a||!o||l&&d.isLabel||!e.visible||!c)return;const{scaleX:u,scaleY:f}=this._getScreenScale(e,h.pixelRatio);(0,ft.xO)(ir,t),e.attributes.has(We.T.FEATUREATTRIBUTE)&&function(e){const t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),d=1/Math.sqrt(n*n+s*s+a*a),u=1/Math.sqrt(o*o+l*l+c*c);e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=n*d,e[4]=s*d,e[5]=a*d,e[6]=o*u,e[7]=l*u,e[8]=c*u}(ir);const p=e.attributes.get(We.T.POSITION),g=e.attributes.get(We.T.SIZE),_=e.attributes.get(We.T.NORMAL),m=e.attributes.get(We.T.ROTATION),v=e.attributes.get(We.T.CENTEROFFSETANDDISTANCE);(0,we.hu)(p.size>=3);const y=(0,Mi.c)(d),w="screen"===this.parameters.centerOffsetUnits;for(let x=0;x<p.data.length/p.size;x++){const e=x*p.size;(0,Je.i)(Xi,p.data[e],p.data[e+1],p.data[e+2]),(0,Je.t)(Xi,Xi,t),(0,Je.t)(Xi,Xi,h.viewMatrix);const r=x*v.size;if((0,Je.i)(sr,v.data[r],v.data[r+1],v.data[r+2]),!w&&(Xi[0]+=sr[0],Xi[1]+=sr[1],0!==sr[2])){const e=sr[2];(0,Je.n)(sr,Xi),(0,Je.d)(Xi,Xi,(0,Je.h)(sr,sr,e))}const n=x*_.size;if((0,Je.i)(Ji,_.data[n],_.data[n+1],_.data[n+2]),qi(Ji,ir,h,lr),this._applyVerticalOffsetTransformationView(Xi,lr,h,Wi),h.applyProjection(Xi,Qi),Qi[0]>-1){w&&(sr[0]||sr[1])&&(Qi[0]+=sr[0]*h.pixelRatio,0!==sr[1]&&(Qi[1]+=(0,Oi.sX)(sr[1],Wi.factorAlignment)*h.pixelRatio),h.unapplyProjection(Qi,Xi)),Qi[0]+=this.parameters.screenOffset[0]*h.pixelRatio,Qi[1]+=this.parameters.screenOffset[1]*h.pixelRatio,Qi[0]=Math.floor(Qi[0]),Qi[1]=Math.floor(Qi[1]);const e=x*g.size;dr[0]=g.data[e],dr[1]=g.data[e+1],(0,Oi.TU)(dr,Wi.factor,dr);const t=cr*h.pixelRatio;let r=0;d.textureIsSignedDistanceField&&(r=Math.min(d.outlineSize,.5*dr[0])*h.pixelRatio/2),dr[0]*=u,dr[1]*=f;const n=x*m.size,a=d.rotation+m.data[n];if(ki(c,Qi[0],Qi[1],dr,t,r,a,d,y)){const e=i.ray;if((0,Je.t)($i,Xi,(0,ve.U_)(nr,h.viewMatrix)),Qi[0]=c[0],Qi[1]=c[1],h.unprojectFromRenderScreen(Qi,Xi)){const t=(0,M.Ue)();(0,Je.c)(t,e.direction);const i=1/(0,Je.l)(t);(0,Je.h)(t,t,i),s((0,Je.j)(e.origin,Xi)*i,t,-1,!0,1,$i)}}}}}intersectDraped(e,t,i,r,n,s){const a=e.attributes.get(We.T.POSITION),o=e.attributes.get(We.T.SIZE),l=e.attributes.get(We.T.ROTATION),c=this.parameters,h=(0,Mi.c)(c),{scaleX:d,scaleY:u}=this._getScreenScale(e,e.screenToWorldRatio),f=hr*e.screenToWorldRatio;for(let p=0;p<a.data.length/a.size;p++){const t=p*a.size,i=a.data[t],g=a.data[t+1],_=p*o.size;dr[0]=o.data[_],dr[1]=o.data[_+1];let m=0;c.textureIsSignedDistanceField&&(m=Math.min(c.outlineSize,.5*dr[0])*e.screenToWorldRatio/2),dr[0]*=d,dr[1]*=u;const v=p*l.size,y=c.rotation+l.data[v];ki(r,i,g,dr,f,m,y,c,h)&&n(s.dist,s.normal,-1,!1)}}createBufferWriter(){return new _r}_updateScaleInfo(e,t,i){const r=this.parameters;null!=r.screenSizePerspective?(0,Oi.PV)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=r.screenSizePerspectiveAlignment?(0,Oi.PV)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,i,r,n,s,a){const o=qi(t,i,n,lr);return this._applyVerticalGroundOffsetView(e,o,n,a),this._applyVerticalOffsetTransformationView(a,o,n,s),this._applyPolygonOffsetView(a,o,r[3],n,a),this._applyCenterOffsetView(a,r,a),a}applyShaderOffsetsNDC(e,t,i,r,n){return this._applyCenterOffsetNDC(e,t,i,r),null!=n&&(0,Je.c)(n,r),this._applyPolygonOffsetNDC(r,t,i,r),r}_applyPolygonOffsetView(e,t,i,r,n){const s=r.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=s);const o=s*a;if(this.parameters.shaderPolygonOffset<=0)return(0,Je.c)(n,e);const l=(0,J.uZ)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/r.viewport[2];return(0,Je.h)(n,e,o>0?c:1/c),n}_applyVerticalGroundOffsetView(e,t,i,r){const n=(0,Je.l)(e),s=i.aboveGround?1:-1,a=i.computeRenderPixelSizeAtDist(n)*Ti.c,o=(0,Je.h)(Xi,t.normal,s*a);return(0,Je.g)(r,e,o),r}_applyVerticalOffsetTransformationView(e,t,i,r){var n,s;const a=this.parameters;if(null===(n=a.verticalOffset)||void 0===n||!n.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){const i=(0,Je.l)(e);this._updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const o=(0,Je.l)(e),l=null!==(s=a.screenSizePerspectiveAlignment)&&void 0!==s?s:a.screenSizePerspective,c=(0,jt.Hx)(i,o,a.verticalOffset,t.cosAngle,l);return this._updateScaleInfo(r,o,t.cosAngle),(0,Je.h)(t.normal,t.normal,c),(0,Je.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,Je.c)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&((0,Je.n)(Ji,i),(0,Je.g)(i,i,(0,Je.h)(Ji,Ji,t[2])))),i}_applyCenterOffsetNDC(e,t,i,r){const n="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,Je.c)(r,e),n||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}_applyPolygonOffsetNDC(e,t,i,r){const n=this.parameters.shaderPolygonOffset;if(e!==r&&(0,Je.c)(r,e),n){const e=i.aboveGround?1:-1,s=e*Math.sign(t[3]);r[2]-=(s||e)*n}return r}set visible(e){this._visible=e}get visible(){const{color:e,outlineSize:t,outlineColor:i}=this.parameters,r=e[3]>=Ci.e||t>=Ci.e&&i[3]>=Ci.e;return this._visible&&r}createGLMaterial(e){return new Yi(e)}calculateRelativeScreenBounds(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,I.Ue)();return function(e,t,i,r){r[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*i,r[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*i}(this.parameters,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}_getScreenScale(e,t){const i=e.attributes.get(We.T.FEATUREATTRIBUTE);if(null==i)return{scaleX:t,scaleY:t};const r=(0,k.nI)(i.data,or);return(0,bi.FE)(ar,this.parameters,r),{scaleX:ar[0]*t,scaleY:ar[1]*t}}}class Yi extends Ii.Fj{constructor(e){super((0,wi.Z)((0,wi.Z)({},e),e.material.parameters))}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.acquireTechnique(Ni,e)}}function qi(e,t,i,r){return xi(t)&&(t=(0,ft.xO)(rr,t)),(0,Je.q)(r.normal,e,t),(0,Je.t)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=(0,Je.f)(Ki,ur),r}function ki(e,t,i,r,n,s,a,o,l){let c=t-n-r[0]*l[0],h=c+r[0]+2*n,d=i-n-r[1]*l[1],u=d+r[1]+2*n;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&null!=f&&(c+=r[0]*f[0],d+=r[1]*f[1],h-=r[0]*(1-f[2]),u-=r[1]*(1-f[3]),c-=s,h+=s,d-=s,u+=s),(0,W.t8)(tr,t,i),(0,W.U1)(er,e,tr,(0,J.Vl)(a)),er[0]>c&&er[0]<h&&er[1]>d&&er[1]<u}const Wi=new class{constructor(){this.factor=new Ei,this.factorAlignment=new Ei}},Xi=(0,M.Ue)(),Ji=(0,M.Ue)(),Qi=(0,k.Ue)(),Ki=(0,M.Ue)(),$i=(0,M.Ue)(),er=(0,X.Ue)(),tr=(0,X.Ue)(),ir=(0,pt.Ue)(),rr=(0,pt.Ue)(),nr=(0,ye.Ue)(),sr=(0,M.Ue)(),ar=(0,M.Ue)(),or=(0,k.Ue)(),lr={normal:Ki,cosAngle:0},cr=1,hr=2,dr=[0,0],ur=(0,M.al)(0,0,1);class fr extends Ii.EY{constructor(){super(...arguments),this.renderOccluded=Ri.yD.Occlude,this.isDecoration=!1,this.color=(0,k.vV)(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=(0,X.al)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,k.vV)(1,1,1,1),this.outlineSize=0,this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1,this.isLabel=!1}}const pr=(0,Qe.U$)().vec3f(We.T.POSITION).vec3f(We.T.NORMAL).vec2f(We.T.UV0).vec4u8(We.T.COLOR).vec2f(We.T.SIZE).f32(We.T.ROTATION).vec4f(We.T.CENTEROFFSETANDDISTANCE).vec4f(We.T.FEATUREATTRIBUTE),gr=pr.clone().vec4u8(We.T.OBJECTANDLAYERIDCOLOR);class _r{constructor(){this.vertexBufferLayout=(0,Si.B)()?gr:pr}elementCount(e){return 6*e.get(We.T.POSITION).indices.length}write(e,t,i,r,n,s){var a;(0,Ai.ho)(i.get(We.T.POSITION),e,n.position,s,6),(0,Ai.s5)(i.get(We.T.NORMAL),t,n.normal,s,6);const o=null===(a=i.get(We.T.UV0))||void 0===a?void 0:a.data;let l=0,c=0,h=1,d=1;o&&o.length>=4&&(l=o[0],c=o[1],h=o[2],d=o[3]),h=Math.min(1.99999,h+1),d=Math.min(1.99999,d+1);let u=i.get(We.T.POSITION).indices.length,f=s;const p=n.uv0;for(let y=0;y<u;++y)p.set(f,0,l),p.set(f,1,c),f++,p.set(f,0,h),p.set(f,1,c),f++,p.set(f,0,h),p.set(f,1,d),f++,p.set(f,0,h),p.set(f,1,d),f++,p.set(f,0,l),p.set(f,1,d),f++,p.set(f,0,l),p.set(f,1,c),f++;(0,Ai.Vs)(i.get(We.T.COLOR),4,n.color,s,6);const{data:g,indices:_}=i.get(We.T.SIZE);u=_.length;const m=n.size;f=s;for(let y=0;y<u;++y){const e=g[2*_[y]],t=g[2*_[y]+1];for(let i=0;i<6;++i)m.set(f,0,e),m.set(f,1,t),f++}if((0,Ai.XW)(i.get(We.T.ROTATION),n.rotation,s,6),i.get(We.T.CENTEROFFSETANDDISTANCE)?(0,Ai.SW)(i.get(We.T.CENTEROFFSETANDDISTANCE),n.centerOffsetAndDistance,s,6):(0,Ai.h)(n.centerOffsetAndDistance,s,6*u),i.get(We.T.FEATUREATTRIBUTE)?(0,Ai.SW)(i.get(We.T.FEATUREATTRIBUTE),n.featureAttribute,s,6):(0,Ai.h)(n.featureAttribute,s,6*u),null!=r){var v;const e=null===(v=i.get(We.T.POSITION))||void 0===v?void 0:v.indices;if(e){const t=e.length,i=n.getField(We.T.OBJECTANDLAYERIDCOLOR,gt.mc);(0,Ai.xP)(r,i,t,s,6)}}}}var mr=i(45856);let vr=class extends p.Z{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){}async executeRenderCommands(e){for(const t of e)switch(t.id){case"create-material":await this._createMaterial(t);break;case"create-direct-renderer":await this._createDirectRenderer(t);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(t);break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(t);break;case"create-lod-renderer":await this._createLodRenderer(t);break;case"add-lod-instances":await this._addLodInstances(t);break;case"remove-lod-instances":await this._removeLodInstances(t)}}async _createMaterial(e){const{view:t}=this,{sharedSymbolResources:i}=t;if(null==i)throw new Error("No shared symbol resources found!");const{textures:r}=i,n=t.state.viewingMode===j.JY.Global;let s=null;switch(e.type){case"default":s=function(e,t,i){const r={usePBR:t.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:mr.S7,ambient:M.hq,diffuse:M.hq,hasSlicePlane:t.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:t.castShadows,offsetTransparentBackfaces:!t.isPrimitive};return function(e){var t;const i=null!==(t=e.opacity)&&void 0!==t?t:1,r=i<1;e.transparent=r,e.opacity=i,e.cullFace=r?oe.Vr.None:oe.Vr.Back}(r),t.screenSizePerspectiveEnabled&&(r.screenSizePerspective=e.screenSizePerspectiveSettings),r.externalColor=k.hq,r.isInstanced=!0,new yi.Gp(r,{spherical:i,doublePrecisionRequiresObfuscation:!0})}(i,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:t._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},n);break;case"hud":{const[e,t]=yr(r,n);this.addHandles([(0,Y.kB)((()=>(0,q.RY)(t)))]),s=e}break;default:throw new Error("unable to create unknown material type ".concat(e.type))}this._materials.set(e.materialId,s)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const t=e.materialId,i=this._getMaterial(t);if(null==i)throw new Error("material not found ".concat(t));const{view:r}=this,n=new Ze({material:i});this._directRenderers.set(t,n),r._stage.addRenderPlugin(n),r._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const t=e.renderGeometryId,i=e.materialId;null!=this._renderGeometries.get(t)&&await this._removeDirectRendererGeometry({renderGeometryId:t});const r=this._directRenderers.get(i);if(null==r)return void console.error("no renderer assigned to provided material");const n=r.addRenderGeometry(t,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(t,{renderGeometry:n,materialId:i}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const t=e.renderGeometryId,i=this._renderGeometries.get(t);if(null==i)return;const r=i.materialId,n=this._directRenderers.get(r);null!=n?n.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const t=new li({view:this.view,layerUid:this.layerUid}),i=new AbortController;await t.doLoad(e.lodRenderGeometry,(e=>this._getMaterial(e)),i.signal),this._lodRenderers.set(e.lodRendererId,t)}async _addLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(null==t)throw new Error("no lod renderer assigned to provided lod renderer Id");t.addInstances(e.data)}async _removeLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(null==t)throw new Error("no lod renderer assigned to provided lod renderer Id");t.removeInstances(e.featureIds)}};function yr(e,t){const i={anchorPosition:ee.center,occlusionTest:!0,hasSlicePlane:!1},r=i;r.color=[1,0,0,1],r.outlineColor=[0,0,0,1],r.outlineSize=1;if(null!=e){const t=e.fromData("circle-icon",(()=>fi("circle")));r.textureId=t.texture.id,r.textureIsSignedDistanceField=!0,r.sampleSignedDistanceFieldTexelCenter=function(e){return"cross"===e||"x"===e}("circle")}return r.distanceFieldBoundingBox=wr,[new Zi(i,t),null]}vr=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],vr);const wr=[ui/2,ui/2,1-ui/2,1-ui/2];class xr{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const i=this._bufferWriter;let r=null;if(e.transformation&&t)(0,ve.JG)(br,e.transformation),br[12]-=t[0],br[13]-=t[1],br[14]-=t[2],r=br;else{if(t)throw new Error("not implemented");e.transformation&&(r=e.transformation)}let n=null;r&&((0,ve.U_)(Tr,br),(0,ve.p4)(Tr,Tr),n=Tr);const s=e.attributes,a=i.elementCount(s),o=i.vertexBufferLayout.stride/4;a>Math.floor(Cr/o)&&console.warn("geometry with very large number of elements encountered");const l=i.vertexBufferLayout.createBuffer(a);return i.write(r,n,s,e.objectAndLayerIdColor,l,0),{data:l.buffer,elementCount:a}}}const br=(0,ye.Ue)(),Tr=(0,ye.Ue)(),Cr=4194304;var Sr,Ir=i(47180);class Rr{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,i=t.generateId("material");switch(e){case"default":{const e=new yi.Gp({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),r=new xr(e);t.registerRenderGeometryBufferWriter(i,r)}break;case"hud":{const e=yr(null,this._context.globalViewingMode)[0],r=new xr(e);t.registerRenderGeometryBufferWriter(i,r)}}return this._commands.push({id:"create-material",type:e,materialId:i}),i}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,i){const r=t.materialId,n=this._context.getRenderGeometryBufferWriter(r);if(null==n)throw new Error("no bufferwriter found for material ".concat(r));const s=n.createBuffer(t,i);this._transferables.add(s.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:r,renderGeometryBuffer:s,localOrigin:i})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),i={levels:e.levels.map((e=>({components:e.components.map((e=>{const t=e.attributes.get(We.T.POSITION);if(!t||0===t.indices.length)throw new Error("positions attribute expected");const i=(0,Z.KF)(t.indices.length/3),r=new Ir.j(i,3,t),n=this._context.getRenderGeometryBufferWriter(e.materialId);if(null==n)throw new Error("writer not found");const s=n.createBuffer(e,null);return this._transferables.add(s.data),{materialId:e.materialId,renderGeometryBuffer:s,boundingInfo:{bbMax:r.bbMax,bbMin:r.bbMin}}})),minScreenSpaceRadius:e.minScreenSpaceRadius})))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:i}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}class Or{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===j.JY.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(){return"".concat(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").concat(this._idCounter++)}createEncoder(){return new Rr(this)}async dispatchRenderCommands(e,t){this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}!function(e){e[e.OBJECT_ID=0]="OBJECT_ID",e[e.PARTITION_ID=1]="PARTITION_ID",e[e.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",e[e.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",e[e.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"}(Sr||(Sr={}));var Er=i(50628),Ar=i(5986);async function Mr(e,t){const{numFeatures:i,tile:r,partitionInfo:n}=e,{pages:s}=r;if(0===s.length||0===i)return new Uint32Array;const a=new Uint32Array(i);if(n){const e=s.reduce(((e,t)=>{let{featureCount:i}=t;return e+i}),0),t=new Uint32Array(e);let r=0;for(const i of s)r=i.readAllObjectIds(t,r);const o=n.tileIndices;for(let n=0;n<i;++n){const e=t[o[n]];a[n]=e}}else{let e=0;for(const t of s)e=t.readAllObjectIds(a,e)}return a}async function Dr(e,t){const{numFeatures:i,tile:r,partitionInfo:n}=e,{pages:s}=r;if(0===s.length||0===i)return new Float64Array;const a=new Float64Array(3*i);if(n){const e=s.reduce(((e,t)=>{let{featureCount:i}=t;return e+i}),0),t=new Float64Array(3*e);let r=0;for(const i of s)r=i.readAllCoordinates(t,r);const o=n.tileIndices;for(let n=0;n<i;++n){const e=o[n],i=t[3*e+0],r=t[3*e+1],s=t[3*e+2];a[3*n+0]=i,a[3*n+1]=r,a[3*n+2]=s}}else{let e=0;for(const t of s)e=t.readAllCoordinates(a,e)}return a}async function Fr(e,t){await e.provision([Sr.GEOMETRY_MAP_COORDINATES],t);const{numFeatures:i,tile:r,mapCoordinates:n}=e,{pages:s}=r;if(0===s.length||0===i)return new Float64Array;const a=t.viewSpatialReference,o=t.renderSpatialReference,l=new Float64Array(3*i);if(!(0,Er.projectBuffer)(n,a,0,l,o,0,i))throw new Error("Failed to project coordinates");return l}async function Pr(e,t){const i=t.viewSpatialReference,r=t.renderSpatialReference,n=e.tile.descriptor.extent,s=(0,I.be)(n),a=(0,M.Ue)();return(0,Ar.S)([s[0],s[1],0],i,a,r),a}class Lr{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._tile=e,this._numFeatures=t,this._partitionInfo=i}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(null==this._objectIds)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(null==this._partitionIds)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(null==this._mapCoordinates)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(null==this._renderCoordinates)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(null==this._tileCenterRenderCoordinates)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}async provision(e,t){for(const i of e)switch(i){case Sr.OBJECT_ID:if(this._objectIds)return;this._objectIds=await Mr(this);break;case Sr.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case Sr.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=await Dr(this);break;case Sr.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=await Fr(this,t);break;case Sr.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=await Pr(this,t);break;default:throw new Error("not implemented")}}dispose(){if(this.partitions){for(const e of this.partitions)e.dispose();this.partitions=void 0}}}var Br=i(86452),Nr=i(53720),Ur=i(68860);i(45925),i(4954),i(69662),i(69048),i(37818);function Hr(e){const t=new Map;for(const[i,r]of e)t.set(i,(0,wi.Z)((0,wi.Z)({},r),{},{indices:(0,Z.mi)(r.indices)}));return t}var zr,Gr=i(41134),Vr=i(93311),jr=(i(86372),i(38461)),Zr=i(55652),Yr=i(91526);!function(e){e.length=function(e,t){const i=e[t],r=e[t+1],n=e[t+2];return Math.sqrt(i*i+r*r+n*n)},e.normalize=function(e,t){const i=e[t],r=e[t+1],n=e[t+2],s=1/Math.sqrt(i*i+r*r+n*n);e[t]*=s,e[t+1]*=s,e[t+2]*=s},e.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},e.add=function(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[s]=e[t]+i[r],n[s+1]=e[t+1]+i[r+1],n[s+2]=e[t+2]+i[r+2]},e.subtract=function(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[s]=e[t]-i[r],n[s+1]=e[t+1]-i[r+1],n[s+2]=e[t+2]-i[r+2]}}(zr||(zr={}));i(79100),i(71228);const qr=new Array(36);for(let Fn=0;Fn<6;Fn++)for(let e=0;e<6;e++)qr[6*Fn+e]=Fn;const kr=new Array(36);for(let Fn=0;Fn<6;Fn++)kr[6*Fn]=0,kr[6*Fn+1]=1,kr[6*Fn+2]=2,kr[6*Fn+3]=2,kr[6*Fn+4]=3,kr[6*Fn+5]=0;const Wr=(0,Vr.al)(-.5,0,-.5),Xr=(0,Vr.al)(.5,0,-.5),Jr=(0,Vr.al)(0,0,.5),Qr=(0,Vr.al)(0,.5,0),Kr=(0,Vr.Ue)(),$r=(0,Vr.Ue)(),en=(0,Vr.Ue)(),tn=(0,Vr.Ue)(),rn=(0,Vr.Ue)();(0,Je.d)(Kr,Wr,Qr),(0,Je.d)($r,Wr,Xr),(0,Je.e)(en,Kr,$r),(0,Je.n)(en,en),(0,Je.d)(Kr,Xr,Qr),(0,Je.d)($r,Xr,Jr),(0,Je.e)(tn,Kr,$r),(0,Je.n)(tn,tn),(0,Je.d)(Kr,Jr,Qr),(0,Je.d)($r,Jr,Wr),(0,Je.e)(rn,Kr,$r),(0,Je.n)(rn,rn);en[0],en[1],en[2],tn[0],tn[1],tn[2],rn[0],rn[1],rn[2];function nn(e,t,i,r){let n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=0;const o=t,l=e;let c=(0,Vr.al)(0,a,0),h=(0,Vr.al)(0,a+l,0),d=(0,Vr.al)(0,-1,0),u=(0,Vr.al)(0,1,0);r&&(a=l,h=(0,Vr.al)(0,0,0),c=(0,Vr.al)(0,a,0),d=(0,Vr.al)(0,1,0),u=(0,Vr.al)(0,-1,0));const f=[h,c],p=[d,u],g=i+2,_=Math.sqrt(l*l+o*o);if(r)for(let x=i-1;x>=0;x--){const e=x*(2*Math.PI/i),t=(0,Vr.al)(Math.cos(e)*o,a,Math.sin(e)*o);f.push(t);const r=(0,Vr.al)(l*Math.cos(e)/_,-o/_,l*Math.sin(e)/_);p.push(r)}else for(let x=0;x<i;x++){const e=x*(2*Math.PI/i),t=(0,Vr.al)(Math.cos(e)*o,a,Math.sin(e)*o);f.push(t);const r=(0,Vr.al)(l*Math.cos(e)/_,o/_,l*Math.sin(e)/_);p.push(r)}const m=new Array,v=new Array;if(n){for(let e=3;e<f.length;e++)m.push(1),m.push(e-1),m.push(e),v.push(0),v.push(0),v.push(0);m.push(f.length-1),m.push(2),m.push(1),v.push(0),v.push(0),v.push(0)}if(s){for(let e=3;e<f.length;e++)m.push(e),m.push(e-1),m.push(0),v.push(e),v.push(e-1),v.push(1);m.push(0),m.push(2),m.push(f.length-1),v.push(1),v.push(2),v.push(p.length-1)}const y=(0,jr.xx)(3*g);for(let x=0;x<g;x++)y[3*x]=f[x][0],y[3*x+1]=f[x][1],y[3*x+2]=f[x][2];const w=(0,jr.xx)(3*g);for(let x=0;x<g;x++)w[3*x]=p[x][0],w[3*x+1]=p[x][1],w[3*x+2]=p[x][2];return[[We.T.POSITION,new Yr.a(y,m,3,!0)],[We.T.NORMAL,new Yr.a(w,v,3,!0)]]}(0,M.Ue)();function sn(e,t){const i=function(e,i){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return{levels:e.map((e=>{const n=Hr(i(e.tesselation));return r&&function(e){const t=e,i=t.get(We.T.POSITION).data,r=t.get(We.T.NORMAL).data;if(r){const t=an(e,We.T.NORMAL).data;for(let e=0;e<r.length;e+=3){const i=r[e+1];t[e+1]=-r[e+2],t[e+2]=i}}if(i){const t=an(e,We.T.POSITION).data;for(let e=0;e<i.length;e+=3){const r=i[e+1];t[e+1]=-i[e+2],t[e+2]=r}}}(n),{components:[{attributes:n,objectAndLayerIdColor:void 0,transformation:null,materialId:t}],minScreenSpaceRadius:e.minScreenSpaceRadius}}))}};switch(e){case"cone":return i(on,(e=>nn(1,.5,e,!1)),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function an(e,t){let i=e.get(t);return i&&!i.exclusive&&(i=(0,wi.Z)((0,wi.Z)({},i),{},{exclusive:!0,data:(0,Gr.C)(i.data)}),e.set(t,i)),i}const on=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let ln=class extends p.Z{constructor(e){super(),this._context=e,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}async load(e){const t=sn("cone",e.createMaterial("default"));this.lodRendererId=e.createLodRenderer(t),this._loaded=!0}async add(e,t){if(null==this.lodRendererId)throw new Error("expected lod renderer id to not be null");await this._provisionFeatureData(e);const i=e.numFeatures,r=(0,D.Ue)((0,Nr.Uz)("cone")),n=(0,M.nI)((0,D.dp)(r)),s=(0,M.nI)((0,Nr.$K)(n,{isPrimitive:!0,width:100,depth:null,height:null})),a=new Float64Array(16*i),o=new Float64Array(16*i),l=e.mapCoordinates;for(let h=0;h<i;++h){const e=h,t=l[3*h+0],i=l[3*h+1],r=l[3*h+2],c=this._computeGlobalTransform(t,i,r,this._context.viewSpatialReference,dn),d=this._computeLocalTransform(s,n,hn);this._writeMatrixToTypedBuffer(a,e,d),this._writeMatrixToTypedBuffer(o,e,c)}const c={featureIds:new Uint32Array(e.objectIds),localTransforms:a,globalTransforms:o};t.addLodInstances(this.lodRendererId,c)}async remove(e,t){if(null==this.lodRendererId)return;const i=new Uint32Array(e.objectIds);t.removeLodInstances(this.lodRendererId,i)}async _provisionFeatureData(e){await e.provision([Sr.GEOMETRY_MAP_COORDINATES,Sr.OBJECT_ID],this._context)}_writeMatrixToTypedBuffer(e,t,i){let r=16*t;for(let n=0;n<16;n++)e[r++]=i[n]}_computeGlobalTransform(e,t,i,r,n){return cn[0]=e,cn[1]=t,cn[2]=i,(0,Br.B)(r,cn,n,this._context.renderSpatialReference),n}_computeLocalTransform(e,t,i){return(0,ve.yR)(i),this._applyObjectScale(e,t,i),i}_applyObjectScale(e,t,i){const r=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M.hq,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const n=new Array(3);if(null==t||null==i)n[0]=1,n[1]=1,n[2]=1;else{let r,s=0;for(let a=2;a>=0;a--){const o=e[a];let l;const c=null!=o,h=0===a&&!r&&!c,d=i[a];"symbol-value"===o||h?l=0!==d?t[a]/d:1:c&&"proportional"!==o&&isFinite(o)&&(l=0!==d?o/d:1),null!=l&&(n[a]=l,r=l,s=Math.max(s,Math.abs(l)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=r:0===n[e]&&(n[e]=.001*s)}for(let s=2;s>=0;s--)n[s]/=r;return(0,M.nI)(n)}(e,e,t,this._context.renderCoordsHelper.unitInMeters);1===r[0]&&1===r[1]&&1===r[2]||(0,ve.bA)(i,i,r)}};ln=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],ln);const cn=(0,M.Ue)(),hn=(0,ye.Ue)(),dn=(0,ye.Ue)();let un=class extends p.Z{constructor(e){super(),this._context=e,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}async load(e){this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),this._loaded=!0}async add(e,t){if(null==this.materialId)throw new Error("expected material not to be null");await this._provisionFeatureData(e);const{numFeatures:i,tileId:r,renderCoordinates:n,tileCenterRenderCoordinates:s}=e,a=new Float64Array([0,0,1]),o=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),h=new Float64Array([0,0]),d=new Float64Array([0]),u=new Uint32Array(i);for(let b=0;b<i;++b)u[b]=b;const f=new Uint32Array(i);for(let b=0;b<i;++b)f[b]=0;const p=new Yr.a(n,u,3,!0),g=new Yr.a(a,f,3,!0),_=new Yr.a(h,f,2,!0),m=new Yr.a(o,f,4,!0),v=new Yr.a(d,f,1,!0),y=new Yr.a(l,f,2,!0),w=new Yr.a(c,f,4,!0),x={attributes:Hr([[We.T.POSITION,p],[We.T.NORMAL,g],[We.T.UV0,_],[We.T.COLOR,m],[We.T.ROTATION,v],[We.T.SIZE,y],[We.T.CENTEROFFSETANDDISTANCE,w]]),objectAndLayerIdColor:void 0,transformation:(0,ye.Ue)(),materialId:this.materialId};t.addDirectRendererGeometry(r,x,s)}async remove(e,t){t.removeDirectRendererGeometry(e.tileId)}async _provisionFeatureData(e){await e.provision([Sr.GEOMETRY_RENDER_COORDINATES,Sr.TILE_CENTER_RENDER_COORDINATES],this._context)}};un=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],un);class fn{constructor(e){this._symbols=new Map,this._context=e}async load(){this._symbols.set(0,new un(this._context)),this._symbols.set(1,new ln(this._context))}async add(e,t){await this._provisionFeatureData(e,this._context);const i=this._partition(e);await Promise.all(i.map((async e=>{var i;const r=await this._provisionSymbol(null===(i=e.partitionInfo)||void 0===i?void 0:i.index,t);r&&await r.add(e,t)})))}async remove(e,t){const i=e.partitions;if(!i)throw new Error("partitioned featureset expected");await Promise.all(i.map((async e=>{var i;const r=await this._provisionSymbol(null===(i=e.partitionInfo)||void 0===i?void 0:i.index,t);r&&await r.remove(e,t)})))}async _provisionFeatureData(e,t){await e.provision([Sr.PARTITION_ID,Sr.OBJECT_ID],t)}async _provisionSymbol(e,t){if(null==e)return null;const i=this._symbols.get(e);return i?(i.loaded||await i.load(t),i):null}_partition(e){const{numFeatures:t,objectIds:i,partitionIds:r}=e,n=[[],[]];for(let s=0;s<t;++s){const e=i[s]%2;n[e].push(s),r[s]=e}return e.partitions=n.filter((e=>e.length>0)).map(((t,i)=>{const r=t.length,n={index:i,tileIndices:new Uint32Array(t)};return new Lr(e.tile,r,n)})),e.partitions}}var pn=i(83448),gn=i(29691),_n=i(68859);function mn(e,t,i){return!!(0,Ar.S)(e,t,vn,i.spatialReference)&&(i.x=vn[0],i.y=vn[1],i.z=vn[2],!0)}const vn=(0,M.Ue)();var yn=i(14320),wn=i(82218);function xn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return{operations:e,value:e.create()}}(e);return i.operations=e,e.copy(t,i.value),i}const bn=2**50;function Tn(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function Cn(e,t,i){return e.operations.elevate(e.value,t,i.value)}const Sn=(0,M.Ue)();(0,M.Ue)();var In=i(11185);function Rn(e){return"point"===e.type}class On{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=r,this._tmpCoordinateSystem=function(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}(r),this.referenceEllipsoid=(0,pn.Iu)(t),this.sphericalPCPF=(0,gn.rS)(t)}set extent(e){e&&function(e,t,i){e.operations.setExtent(e.value,t,i.value)}(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return function(e,t){return e.operations.getExtent(e.value,t),t}(this._coordinateSystem,(0,I.Ue)())}getAltitude(e){return function(e,t){return e.operations.altitudeAt(e.value,t)}(this._coordinateSystem,e)}setAltitude(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return Tn(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){!function(e,t,i,r){t!==r&&(0,ve.JG)(r,t),(0,Je.i)(Sn,r[12],r[13],r[14]),Tn(e,Sn,i,Sn),r[12]=Sn[0],r[13]=Sn[1],r[14]=Sn[2]}(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return function(e,t,i){return e.operations.axisAt(e.value,t,yn.R.Z,i)}(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return function(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,yn.R.X,In.WM.get()),r=this.worldBasisAtPosition(e,yn.R.Y,In.WM.get()),n=this.worldBasisAtPosition(e,yn.R.Z,In.WM.get());return(0,ve.t8)(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,In.WM.get()),r=this.worldBasisAtPosition(e,yn.R.Y,In.WM.get()),n=(0,it.cp)(t,r,i);return(0,J.BV)(n)}intersectManifoldClosestSilhouette(e,t,i){return Cn(this._coordinateSystem,t,this._tmpCoordinateSystem),function(e,t,i){e.operations.intersectRayClosestSilhouette(e.value,t,i)}(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){Cn(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=In.WM.get();return function(e,t,i){return e.operations.intersectRay(e.value,t,i)}(this._tmpCoordinateSystem,e,r)?(0,Je.c)(i,r):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===j.JY.Global)return this.intersectManifold(e,t,i);Cn(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=this._tmpCoordinateSystem.value,n=In.WM.get();return(0,Zr.BR)(r.plane,e,n)?(0,Je.c)(i,n):null}toRenderCoords(e,t,i){return Rn(e)?(0,_n.K)(e,t,this.spatialReference):(0,Ar.S)(e,t,i,this.spatialReference)}fromRenderCoords(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Rn(t)?(null!=i&&(t.spatialReference=i),mn(e,this.spatialReference,t)?t:null):(0,Ar.S)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case j.JY.Local:return new On(j.JY.Local,t,(0,Ur.c9)(t),xn(wn.b,(0,wn.f)([0,0,0],[bn,0,0],[0,bn,0])));case j.JY.Global:return new On(j.JY.Global,t,1,function(e){return xn(At.s,(0,At.f)(0,0,0,(0,pn.Iu)(e).radius))}(t))}}static renderUnitScaleFactor(e,t){return(0,Ur.r6)(e)/(0,Ur.r6)(t)}}class En{constructor(e){this._tileFeatureData=new Map,this._context={viewSpatialReference:e.viewSpatialReference,renderSpatialReference:e.renderSpatialReference,renderCoordsHelper:On.create(e.viewingMode,e.renderSpatialReference)}}async add(e,t){this._featureRenderer||(this._featureRenderer=new fn(this._context),await this._featureRenderer.load());const i=this._addTileFeatureData(e);await this._featureRenderer.add(i,t)}async remove(e,t){const i=this._getFeatureSetFromTileId(e);i&&(this._featureRenderer&&this._featureRenderer.remove(i,t),this._removeTileFeatureData(e))}_getFeatureSetFromTileId(e){return this._tileFeatureData.get(e)}_addTileFeatureData(e){const t=e.descriptor.id,i=e.pages.reduce(((e,t)=>{let{featureCount:i}=t;return e+i}),0),r=new Lr(e,i);return this._tileFeatureData.set(t,r),r}_removeTileFeatureData(e){const t=this._tileFeatureData.get(e);t&&(t.dispose(),this._tileFeatureData.delete(e))}}let An=class extends n.Z.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new T,this._tileManager=new m({addTile:(e,t)=>this._addTile(e,t),removeTiles:e=>this._removeTiles(e)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}async setup(e){let{viewSpatialReference:t,renderSpatialReference:i,viewingMode:r,baseQuery:n,url:s,objectIdField:o,capabilities:l,fieldsIndex:c,timeInfo:h}=e;this._renderCommandContext=new Or({viewingMode:r,dispatchRenderCommandsCallback:(e,t)=>this.remoteClient.invoke("dispatchRenderCommands",e,{transferList:t})});const p=d.Z.fromJSON(t),g=d.Z.fromJSON(i);return this._fetcher=new V(p,f.Z.fromJSON(n),s,o,l),this._symbolizer=new En({viewSpatialReference:p,renderSpatialReference:g,viewingMode:r}),this._queryEngine=new u.q({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:o,fieldsIndex:c,availableFields:[o],spatialReference:t,featureStore:this._featureStore,timeInfo:h}),this._defaultQueryJSON=new f.Z({outSpatialReference:p}).toJSON(),this.addHandles((0,a.YP)((()=>this.updating),(async e=>{this.emit("notify-updating",{updating:e})})),a.nn),Dn}async executeQuery(e,t){return{result:await this._queryEngine.executeQuery(this._ensureQuery(e),t)}}async executeQueryForIds(e,t){const i=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(e),t);return{result:Array.from(i)}}async executeQueryForCount(e,t){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(e),t)}}async executeQueryForExtent(e,t){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t)}}async executeQueryForLatestObservations(e,t){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t)}}async onTileTreeChange(e){return await this._tileManager.onTileTreeChange(e),Dn}async _addTile(e,t){const i=await this._fetcher.fetch(e,t);(0,s.k_)(t),this._featureStore.addTile(i);const r=this._renderCommandContext.createEncoder();return await this._symbolizer.add(i,r),await r.dispatch(),i}async _removeTiles(e){const t=this._renderCommandContext.createEncoder(),i=this._featureStore,r=this._symbolizer;for(const n of e)i.removeTile(n.tileId),await r.remove(n.tileId,t);await t.dispatch()}_ensureQuery(e){return null!==e&&void 0!==e?e:this._defaultQueryJSON}};(0,r._)([(0,o.Cb)()],An.prototype,"updating",null),An=(0,r._)([(0,h.j)("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],An);const Mn=An,Dn={result:void 0}},50256:(e,t,i)=>{i.d(t,{K:()=>s});var r=i(8548),n=i(61109);function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=e.stride;return Array.from(e.fields.keys()).map((r=>{var s,o;const l=e.fields.get(r),c=l.constructor.ElementCount,h=a(l.constructor.ElementType),d=l.offset,u=null!==(s=null===(o=l.optional)||void 0===o?void 0:o.glNormalized)&&void 0!==s&&s;return new n.G(r,c,h,d,i,u,t)}))}function a(e){const t=o[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const o={u8:r.g.UNSIGNED_BYTE,u16:r.g.UNSIGNED_SHORT,u32:r.g.UNSIGNED_INT,i8:r.g.BYTE,i16:r.g.SHORT,i32:r.g.INT,f32:r.g.FLOAT}},28156:(e,t,i)=>{i.d(t,{H:()=>l});var r,n,s=i(30168),a=i(13773),o=i(98634);function l(e){e.uniforms.add(new a.U("alignPixelEnabled",((e,t)=>t.alignPixelEnabled))),e.code.add((0,o.H)(r||(r=(0,s.Z)(["vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"])))),e.code.add((0,o.H)(n||(n=(0,s.Z)(["vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"]))))}},81879:(e,t,i)=>{i.d(t,{R:()=>y,c:()=>v});var r,n,s,a,o,l,c,h=i(30168),d=i(49223),u=i(62993),f=i(82552),p=i(95276),g=i(58406),_=i(98634),m=i(4760);const v=.5;function y(e,t){e.include(u.cK),e.attributes.add(m.T.POSITION,"vec3"),e.attributes.add(m.T.NORMAL,"vec3"),e.attributes.add(m.T.CENTEROFFSETANDDISTANCE,"vec4");const i=e.vertex;(0,f.Sv)(i,t),(0,f.hY)(i,t),i.uniforms.add(new p.N("viewport",((e,t)=>t.camera.fullViewport)),new g.p("polygonOffset",(e=>e.shaderPolygonOffset)),new g.p("cameraGroundRelative",((e,t)=>t.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,d.V)(i),i.constants.add("smallOffsetAngle","float",.984807753012208),i.code.add((0,_.H)(r||(r=(0,h.Z)(["struct ProjectHUDAux {\nvec3 posModel;\nvec3 posView;\nvec3 vnormal;\nfloat distanceToCamera;\nfloat absCosAngle;\n};"])))),i.code.add((0,_.H)(n||(n=(0,h.Z)(["\n    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {\n      float pointGroundSign = ",";\n      if (pointGroundSign == 0.0) {\n        pointGroundSign = cameraGroundRelative;\n      }\n\n      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground\n      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise\n      float groundRelative = cameraGroundRelative * pointGroundSign;\n\n      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is\n      // dropped is instead introduced using the ground-relative position of the symbol and the camera\n      if (polygonOffset > .0) {\n        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);\n        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;\n        float factor = (1.0 - tanAlpha / viewport[2]);\n\n        // same side of the terrain\n        if (groundRelative > 0.0) {\n          posView *= factor;\n        }\n        // opposite sides of the terrain\n        else {\n          posView /= factor;\n        }\n      }\n\n      return groundRelative;\n    }\n  "])),t.terrainDepthTest?_.H.float(0):(0,_.H)(s||(s=(0,h.Z)(["sign(pointGroundDistance)"]))))),t.draped&&!t.hasVerticalOffset||(0,f._8)(i),t.draped||(i.uniforms.add(new g.p("perDistancePixelRatio",((e,t)=>Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)))),i.code.add((0,_.H)(a||(a=(0,h.Z)(["\n    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {\n      float distanceToCamera = length(posView);\n\n      // Compute offset in world units for a half pixel shift\n      float pixelOffset = distanceToCamera * perDistancePixelRatio * ",";\n\n      // Apply offset along normal in the direction away from the ground surface\n      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;\n\n      // Apply the same offset also on the view space position\n      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n\n      posModel += modelOffset;\n      posView += viewOffset;\n    }\n  "])),_.H.float(v)))),t.screenCenterOffsetUnitsEnabled&&(0,f.ZI)(i),t.hasScreenSizePerspective&&(0,u.m8)(i),i.code.add((0,_.H)(o||(o=(0,h.Z)(["\n    vec4 projectPositionHUD(out ProjectHUDAux aux) {\n      vec3 centerOffset = centerOffsetAndDistance.xyz;\n      float pointGroundDistance = centerOffsetAndDistance.w;\n\n      aux.posModel = position;\n      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;\n      aux.vnormal = normal;\n      ","\n\n      // Screen sized offset in world space, used for example for line callouts\n      // Note: keep this implementation in sync with the CPU implementation, see\n      //   - MaterialUtil.verticalOffsetAtDistance\n      //   - HUDMaterial.applyVerticalOffsetTransformation\n\n      aux.distanceToCamera = length(aux.posView);\n\n      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);\n      float cosAngle = dot(aux.vnormal, viewDirObjSpace);\n\n      aux.absCosAngle = abs(cosAngle);\n\n      ","\n\n      ","\n\n      ","\n\n      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);\n\n      ","\n\n      vec4 posProj = proj * vec4(aux.posView, 1.0);\n\n      ","\n\n      ","\n\n      // constant part of polygon offset emulation\n      posProj.z -= groundRelative * polygonOffset * posProj.w;\n      return posProj;\n    }\n  "])),t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);",t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":"",t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":"",t.hasVerticalOffset?(0,_.H)(l||(l=(0,h.Z)(["\n            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);\n            vec3 modelOffset = aux.vnormal * worldOffset;\n            aux.posModel += modelOffset;\n            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n            aux.posView += viewOffset;\n            // Since we elevate the object, we need to take that into account\n            // in the distance to ground\n            pointGroundDistance += worldOffset;"]))):"",t.screenCenterOffsetUnitsEnabled?"":(0,_.H)(c||(c=(0,h.Z)(["\n            // Apply x/y in view space, but z in screen space (i.e. along posView direction)\n            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);\n\n            // Same material all have same z != 0.0 condition so should not lead to\n            // branch fragmentation and will save a normalization if it's not needed\n            if (centerOffset.z != 0.0) {\n              aux.posView -= normalize(aux.posView) * centerOffset.z;\n            }\n          "]))),t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":"",t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""))}},50913:(e,t,i)=>{i.d(t,{R:()=>h});var r,n,s,a=i(30168),o=i(28156),l=i(74876),c=i(98634);function h(e,t){const{vertex:i,fragment:h}=e;e.include(l.H,t),i.include(o.H),t.terrainDepthTest&&e.varyings.add("depth","float"),i.main.add((0,c.H)(r||(r=(0,a.Z)(["\n    vec4 posProjCenter;\n    if (dot(position, position) > 0.0) {\n      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      posProjCenter = alignToPixelCenter(posProj, viewport.zw);\n\n      ","\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        // Project out of clip space\n        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n      }\n\n    } else {\n      // Project out of clip space\n      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n\n    gl_Position = posProjCenter;\n    gl_PointSize = 1.0;\n  "])),t.terrainDepthTest?(0,c.H)(n||(n=(0,a.Z)(["depth = projectAux.posView.z;"]))):"")),h.main.add((0,c.H)(s||(s=(0,a.Z)(["fragColor = vec4(1);\nif(terrainDepthTest(depth)) {\nfragColor.g = 0.5;\n}"]))))}},25477:(e,t,i)=>{i.d(t,{P:()=>d});var r,n=i(30168),s=i(28156);!function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(r||(r={}));var a,o=i(95276),l=i(58406),c=i(98634),h=i(19253);function d(e){e.vertex.uniforms.add(new l.p("renderTransparentlyOccludedHUD",((e,t)=>t.hudRenderStyle===r.Occluded?1:t.hudRenderStyle===r.NotOccluded?0:.75)),new o.N("viewport",((e,t)=>t.camera.fullViewport)),new h.A("hudVisibilityTexture",((e,t)=>{var i;return null===(i=t.hudVisibility)||void 0===i?void 0:i.getTexture()}))),e.vertex.include(s.H),e.vertex.code.add((0,c.H)(a||(a=(0,n.Z)(["bool testHUDVisibility(vec4 posProj) {\nvec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);\nvec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);\nif (renderTransparentlyOccludedHUD > 0.5) {\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;\n}\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;\n}"]))))}},78980:(e,t,i)=>{i.d(t,{n:()=>l});var r,n,s,a=i(30168),o=i(98634);function l(e){e.code.add((0,o.H)(r||(r=(0,a.Z)(["const float MAX_RGBA_FLOAT =\n255.0 / 256.0 +\n255.0 / 256.0 / 256.0 +\n255.0 / 256.0 / 256.0 / 256.0 +\n255.0 / 256.0 / 256.0 / 256.0 / 256.0;\nconst vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\nvec4 float2rgba(const float value) {\nfloat valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\nvec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\nconst float toU8AsFloat = 1.0 / 255.0;\nreturn fixedPointU8 * toU8AsFloat;\n}"])))),e.code.add((0,o.H)(n||(n=(0,a.Z)(["const vec4 RGBA_2_FLOAT_FACTORS = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, RGBA_2_FLOAT_FACTORS);\n}"])))),e.code.add((0,o.H)(s||(s=(0,a.Z)(["const vec4 uninterpolatedRGBAToFloatFactors = vec4(\n1.0 / 256.0,\n1.0 / 256.0 / 256.0,\n1.0 / 256.0 / 256.0 / 256.0,\n1.0 / 256.0 / 256.0 / 256.0 / 256.0\n);\nfloat uninterpolatedRGBAToFloat(vec4 rgba) {\nreturn (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;\n}"]))))}},20395:(e,t,i)=>{i.d(t,{$:()=>s});var r=i(61809),n=i(99340);class s extends r.x{constructor(e,t){super(e,"vec4",n.P.Draw,((i,r,n)=>i.setUniform4fv(e,t(r,n))))}}},54463:(e,t,i)=>{var r,n;i.d(t,{eC:()=>n,q7:()=>r}),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL",e[e.TILES3D=8]="TILES3D"}(r||(r={}));!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(n||(n={}))},55848:(e,t,i)=>{i.d(t,{Dx:()=>n});i(12400);class r{constructor(e){this.layerUid=e}}class n extends r{constructor(e,t){super(e),this.graphicUid=t}}},22178:(e,t,i)=>{i.d(t,{nn:()=>n});i(32035);var r=i(12400);i(82218),i(54463);function n(e){return null!=(null===e||void 0===e?void 0:e.dist)}(0,r.Ue)()},22255:(e,t,i)=>{i.d(t,{x:()=>n});i(54463);var r=i(55848);i(22178);class n extends r.Dx{constructor(e,t,i,r,n,s){super(e,t),this.layerUid=e,this.graphicUid=t,this.geometryId=i,this.triangleNr=r,this.baseBoundingSphere=n,this.numLodLevels=s}}},44070:(e,t,i)=>{i.d(t,{f:()=>c});var r=i(63780),n=(i(93169),i(32718)),s=i(18722),a=i(37825),o=i(8548);const l=()=>n.Z.getLogger("esri.views.webgl.BufferObject");class c{static createIndex(e,t,i){return new c(e,o.w0.ELEMENT_ARRAY_BUFFER,t,i)}static createVertex(e,t,i){return new c(e,o.w0.ARRAY_BUFFER,t,i)}static createUniform(e,t,i){return new c(e,o.w0.UNIFORM_BUFFER,t,i)}static createPixelPack(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.l1.STREAM_READ,i=arguments.length>2?arguments[2]:void 0;const r=new c(e,o.w0.PIXEL_PACK_BUFFER,t);return i&&r.setSize(i),r}static createPixelUnpack(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.l1.STREAM_DRAW,i=arguments.length>2?arguments[2]:void 0;return new c(e,o.w0.PIXEL_UNPACK_BUFFER,t,i)}static createTransformFeedback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.l1.STATIC_DRAW,i=arguments.length>2?arguments[2]:void 0;const r=new c(e,o.w0.TRANSFORM_FEEDBACK_BUFFER,t);return r.setSize(i),r}constructor(e,t,i,r){this._context=e,this.bufferType=t,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(o._g.BufferObject,this),this._glName=this._context.gl.createBuffer(),(0,a.zu)(this._context.gl),r&&this.setData(r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){if(this.bufferType===o.w0.ELEMENT_ARRAY_BUFFER){if(this._indexType===o.g.UNSIGNED_INT)return 4*this._size;if(this._indexType===o.g.UNSIGNED_SHORT)return 2*this._size}return this._size}get _isVAOAware(){return this.bufferType===o.w0.ELEMENT_ARRAY_BUFFER||this.bufferType===o.w0.ARRAY_BUFFER}dispose(){var e;null!==(e=this._context)&&void 0!==e&&e.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(o._g.BufferObject,this),this._context=null):this._glName&&l().warn("Leaked WebGL buffer object")}setSize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.bufferType===o.w0.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case o.g.UNSIGNED_SHORT:e*=2;break;case o.g.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===o.w0.ELEMENT_ARRAY_BUFFER&&((0,s.lq)(e)?this._indexType=o.g.UNSIGNED_BYTE:(0,s.Uc)(e)?(t/=2,this._indexType=o.g.UNSIGNED_SHORT):(0,s.ZY)(e)&&(t/=4,this._indexType=o.g.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const r=this._context.gl;null!=t?r.bufferData(this.bufferType,t,this.usage):r.bufferData(this.bufferType,e,this.usage),(0,a.zu)(r),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,t,i,r){if(!e)return;const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:s}=this._context;s.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,i,r-i),(0,a.zu)(s),this._isVAOAware&&this._context.bindVAO(n)}getSubData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(i<0||n<0)return;const s=function(e){return(0,r.zG)(e)}(e)?e.BYTES_PER_ELEMENT:1;if(s*((null!==i&&void 0!==i?i:0)+(null!==n&&void 0!==n?n:0))>e.byteLength)return;t+s*(null!==n&&void 0!==n?n:0)>this.usedMemory&&l().warn("Potential problem getting subdata: requested data exceeds buffer size!");const a=this._context.gl;this.bufferType===o.w0.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,o.w0.TRANSFORM_FEEDBACK_BUFFER),a.getBufferSubData(o.w0.TRANSFORM_FEEDBACK_BUFFER,t,e,i,n),this._context.unbindBuffer(o.w0.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,o.w0.COPY_READ_BUFFER),a.getBufferSubData(o.w0.COPY_READ_BUFFER,t,e,i,n),this._context.unbindBuffer(o.w0.COPY_READ_BUFFER))}async getSubDataAsync(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;await this._context.clientWaitAsync(),this.getSubData(e,t,i,r)}}},45412:(e,t,i)=>{i.d(t,{U:()=>c});var r=i(32718),n=i(92026),s=i(18722),a=i(8548),o=i(3384);const l=()=>r.Z.getLogger("esri.views.webgl.VertexArrayObject");let c=class{constructor(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this._context=e,this._locations=t,this._layout=i,this._buffers=r,this._indexBuffer=n,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Array.from(this._buffers.values()).reduce(((e,t)=>e+t.usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*s.ru}dispose(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._buffers.forEach((e=>e.dispose())),this._buffers.clear(),this._indexBuffer=(0,n.M2)(this._indexBuffer),this.disposeVAOOnly()):(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(a._g.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(a._g.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:i}=this;e||l().error("Vertex buffer dictionary is empty!");const r=this._context.gl;this._buffers.forEach(((e,i)=>{const r=t.get(i);r?(0,o.XP)(this._context,this._locations,e,r):l().error("Vertex element descriptor is empty!")})),null!=i&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},61109:(e,t,i)=>{i.d(t,{G:()=>r});class r{constructor(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;this.name=e,this.count=t,this.type=i,this.offset=r,this.stride=n,this.normalized=s,this.divisor=a}}}}]);
//# sourceMappingURL=7764.8165aa5e.chunk.js.map